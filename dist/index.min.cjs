"use strict";var e=require("@leafer-in/arrow"),t=require("@leafer-ui/core");function s(e,t,s,i){var n,o=arguments.length,l=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,s,i);else for(var h=e.length-1;h>=0;h--)(n=e[h])&&(l=(o<3?n(l):o>3?n(t,s,l):n(t,s))||l);return o>3&&l&&Object.defineProperty(t,s,l),l}"function"==typeof SuppressedError&&SuppressedError;class i extends e.ArrowData{}const n="#1890FF",o=99999999,l=10,h="round",r="round",d="none",p="none";exports.FreePolyline=class extends e.Arrow{get __tag(){return"FreePolyline"}constructor(e){super(e)}},s([t.boundsType(h)],exports.FreePolyline.prototype,"strokeCap",void 0),s([t.boundsType(r)],exports.FreePolyline.prototype,"strokeJoin",void 0),s([t.boundsType(d)],exports.FreePolyline.prototype,"startArrow",void 0),s([t.boundsType(p)],exports.FreePolyline.prototype,"endArrow",void 0),s([t.dataProcessor(i)],exports.FreePolyline.prototype,"__",void 0),exports.FreePolyline=s([t.registerUI()],exports.FreePolyline);class a extends e.ArrowData{}function x(e){return e.reduce(((e,t,s,i)=>(s>0&&e.push({x:(i[s-1].x+t.x)/2,y:(i[s-1].y+t.y)/2}),e)),[])}function c(e){return e.length?function(e){return e.length&&"object"==typeof e[0]}(e)?e:e.reduce(((e,t,s,i)=>(s%2&&e.push({x:i[s-1],y:t}),e)),[]):e}function y(e,t){return e.y===t.y&&e.x!==t.x}function E(e,t){return e.x===t.x&&e.y!==t.y}function f(e,t,s){const i=[...e.points];i.splice(s,0,...t),e.setAttr("points",i)}function u(e,t,s){const i=[...e.points];i.splice(t,s),e.setAttr("points",i)}function g(e,t){const s=[...e.points];t.forEach((e=>{const{index:t,x:i,y:n}=e;s[t]={x:i,y:n}})),e.setAttr("points",s)}function P(e,t){const s=e[t],i=e[t+1];return y(s,i)?Math.abs(s.x-i.x)>=20:Math.abs(s.y-i.y)>=20}exports.OrthoPolyline=class extends e.Arrow{get __tag(){return"OrthoPolyline"}constructor(e){if(super(e),!this.isOrthoLine(c(this.points)))throw new Error("Params points can't paint an orthogonal polylines!")}isOrthoLine(e){return!(e.length<2)&&e.every(((e,t,s)=>0===t||(y(s[t-1],e)?!s[t-2]||E(s[t-2],s[t-1]):!!E(s[t-1],e)&&(!s[t-2]||y(s[t-2],s[t-1])))))}},s([t.boundsType(h)],exports.OrthoPolyline.prototype,"strokeCap",void 0),s([t.boundsType(r)],exports.OrthoPolyline.prototype,"strokeJoin",void 0),s([t.boundsType(d)],exports.OrthoPolyline.prototype,"startArrow",void 0),s([t.boundsType(p)],exports.OrthoPolyline.prototype,"endArrow",void 0),s([t.dataProcessor(a)],exports.OrthoPolyline.prototype,"__",void 0),exports.OrthoPolyline=s([t.registerUI()],exports.OrthoPolyline);class m extends t.Group{constructor(e={}){const{color:t,strokeWidth:s,ellipseWidth:i}=e;super(),this.color=null!=t?t:n,this.strokeWidth=null!=s?s:2,this.ellipseWidth=null!=i?i:10,this.line=null,this.rect=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}initEvents(){this.waitLeafer((()=>{const{isApp:e,zoomLayer:s}=this.app;if(!e||!s||s!=this.parent)throw new Error("FreePolylineEditor must be added to the zoomLayer of the App!");this.app.on(t.PointerEvent.DOWN,this.downHandler.bind(this)),this.app.on(t.ZoomEvent.ZOOM,this.zoomHandler.bind(this))}))}downHandler(e){const t=e.target;t!==this.selectItem&&t.parent!==this&&(this.selectItem&&(this.selectItem=null,this.clearEditor()),"FreePolyline"===t.tag&&(this.set({x:t.x,y:t.y}),this.selectItem=t,this.drawEditor()))}zoomHandler(){if(!this.selectItem)return;const{scale:e}=this.leafer,t=this.strokeWidth/e,s=this.ellipseWidth/e;this.line.setAttr("strokeWidth",t),this.edgeEllipses.forEach((e=>{e.set({width:s,height:s,strokeWidth:t})})),this.midEllipses.forEach((e=>{e.set({width:s,height:s,strokeWidth:t})}))}drawEditor(){const{points:e}=this.selectItem,t=c(e),s=x(t);this.drawLine(t),this.drawRect(),this.drawEdgeEllipses(t),this.drawMidEllipses(s)}clearEditor(){this.edgeEllipses.forEach((e=>{e.off(t.PointerEvent.DOWN)})),this.midEllipses.forEach((e=>{e.off(t.PointerEvent.DOWN)})),this.rect.off(t.PointerEvent.DOWN),this.line=null,this.rect=null,this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawRect(){const{x:e,y:s,width:i,height:n}=this.selectItem.boxBounds;this.rect=new t.Rect({y:s,x:e,width:i,height:n,fill:"rgba(0, 0, 0, 0)"}),this.add(this.rect),this.addRectEvents(this.rect)}drawLine(e){const{scale:s}=this.leafer,i=this.strokeWidth/s;this.line=new t.Line({points:e,stroke:this.color,strokeWidth:i}),this.add(this.line)}drawEdgeEllipses(e){const{scale:s}=this.leafer,i=this.ellipseWidth/s,n=this.strokeWidth/s;e.forEach(((e,s)=>{const o=new t.Ellipse({width:i,height:i,x:e.x,y:e.y,around:"center",stroke:this.color,strokeWidth:n,fill:"#fff",draggable:!0});this.edgeEllipses.push(o),this.addEdgeEvents(o,s)})),this.add(this.edgeEllipses)}drawMidEllipses(e){const{scale:s}=this.leafer,i=this.ellipseWidth/s,n=this.strokeWidth/s,{points:o}=this.selectItem;e.forEach(((e,s)=>{const l=new t.Ellipse({width:i,height:i,x:e.x,y:e.y,around:"center",stroke:"#fff",strokeWidth:n,fill:this.color,visible:P(o,s)});this.midEllipses.push(l),this.addMidEvents(l,s)})),this.add(this.midEllipses)}addRectEvents(e){e.on(t.PointerEvent.DOWN,(s=>{const{x:i,y:n}=this.selectItem,{x:o,y:l}=s.getPagePoint(),h=this.app.on_(t.PointerEvent.MOVE,(e=>{const{x:t,y:s}=e.getPagePoint();this.selectItem.set({x:i+t-o,y:n+s-l}),this.set({x:i+t-o,y:n+s-l})}));e.on(t.PointerEvent.UP,(()=>{this.app.off_(h),e.off(t.PointerEvent.UP)}))}))}addEdgeEvents(e,s){e.on(t.PointerEvent.DOWN,(i=>{const{x:n,y:o}=e,{x:l,y:h}=i.getPagePoint(),r=this.app.on_(t.PointerEvent.MOVE,(e=>{const{x:t,y:i}=e.getPagePoint(),r={index:s,x:n+t-l,y:o+i-h};(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),g(this.line,[r]),g(this.selectItem,[r])}));e.on(t.PointerEvent.UP,(()=>{this.app.off_(r),e.off(t.PointerEvent.UP),e.off(t.PointerEvent.DOWN),this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds)}))}))}addMidEvents(e,s){e.on(t.PointerEvent.DOWN,(i=>{const{x:n,y:o}=e,{x:l,y:h}=i.getPagePoint();let r=!1;const d=this.app.on_(t.PointerEvent.MOVE,(e=>{const{x:t,y:i}=e.getPagePoint(),d={x:n+t-l,y:o+i-h},p=Object.assign(Object.assign({},d),{index:s+1});(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),r?(g(this.line,[p]),g(this.selectItem,[p])):(r=!0,f(this.line,[d],s+1),f(this.selectItem,[d],s+1))}));e.on(t.PointerEvent.UP,(()=>{this.app.off_(d),e.off(t.PointerEvent.UP),e.off(t.PointerEvent.DOWN),this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds)}))}))}redrawEllipses(){const{points:e}=this.selectItem,t=x(e);this.drawEdgeEllipses(e),this.drawMidEllipses(t)}removeEllipses(){this.edgeEllipses.forEach((e=>{e.remove()})),this.midEllipses.forEach((e=>{e.remove()})),this.edgeEllipses=[],this.midEllipses=[]}}s([t.sortType(o)],m.prototype,"zIndex",void 0);class v extends t.Group{constructor(e={}){const{color:t,strokeWidth:s,ellipseWidth:i}=e;super(),this.color=null!=t?t:n,this.strokeWidth=null!=s?s:2,this.ellipseWidth=null!=i?i:10,this.line=null,this.rect=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}initEvents(){this.waitLeafer((()=>{const{isApp:e,zoomLayer:s}=this.app;if(!e||!s||s!=this.parent)throw new Error("OrthoPolylineEditor must be added to the zoomLayer of the App!");this.app.on(t.PointerEvent.DOWN,this.downHandler.bind(this)),this.app.on(t.ZoomEvent.ZOOM,this.zoomHandler.bind(this))}))}downHandler(e){const t=e.target;t!==this.selectItem&&t.parent!==this&&(this.selectItem&&(this.selectItem=null,this.clearEditor()),"OrthoPolyline"===t.tag&&(this.set({x:t.x,y:t.y}),this.selectItem=t,this.drawEditor()))}zoomHandler(){if(!this.selectItem)return;const{scale:e}=this.leafer,t=this.strokeWidth/e,s=this.ellipseWidth/e;this.line.setAttr("strokeWidth",t),this.edgeEllipses.forEach((e=>{e.set({width:s,height:s,strokeWidth:t})})),this.midEllipses.forEach((e=>{e.set({width:s,height:s,strokeWidth:t})}))}drawEditor(){const{points:e}=this.selectItem,t=c(e),s=x(t);this.drawLine(t),this.drawRect(),this.drawEdgeEllipses(t),this.drawMidEllipses(s)}clearEditor(){this.edgeEllipses.forEach((e=>{e.off(t.PointerEvent.DOWN)})),this.midEllipses.forEach((e=>{e.off(t.PointerEvent.DOWN)})),this.rect.off(t.PointerEvent.DOWN),this.line=null,this.rect=null,this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawRect(){const{x:e,y:s,width:i,height:n}=this.selectItem.boxBounds;this.rect=new t.Rect({y:s,x:e,width:i,height:n,fill:"rgba(0, 0, 0, 0)"}),this.add(this.rect),this.addRectEvents(this.rect)}drawLine(e){const{scale:s}=this.leafer,i=this.strokeWidth/s;this.line=new t.Line({points:e,stroke:this.color,strokeWidth:i}),this.add(this.line)}drawEdgeEllipses(e){const{scale:s}=this.leafer,i=this.ellipseWidth/s,n=this.strokeWidth/s;[e[0],e.at(-1)].forEach(((e,s)=>{const o=new t.Ellipse({width:i,height:i,x:e.x,y:e.y,around:"center",stroke:this.color,strokeWidth:n,fill:"#fff"});this.edgeEllipses.push(o),this.addEdgeEvents(o,s)})),this.add(this.edgeEllipses)}drawMidEllipses(e){const{scale:s}=this.leafer,i=this.ellipseWidth/s,n=this.strokeWidth/s,{points:o}=this.selectItem;e.forEach(((e,s)=>{const l=new t.Ellipse({width:i,height:i,x:e.x,y:e.y,around:"center",stroke:"#fff",strokeWidth:n,fill:this.color,visible:P(o,s)});this.midEllipses.push(l),this.addMidEvents(l,s)})),this.add(this.midEllipses)}addRectEvents(e){e.on(t.PointerEvent.DOWN,(s=>{const{x:i,y:n}=this.selectItem,{x:o,y:l}=s.getPagePoint(),h=this.app.on_(t.PointerEvent.MOVE,(e=>{const{x:t,y:s}=e.getPagePoint();this.selectItem.set({x:i+t-o,y:n+s-l}),this.set({x:i+t-o,y:n+s-l})}));e.on(t.PointerEvent.UP,(()=>{this.app.off_(h),e.off(t.PointerEvent.UP)}))}))}addEdgeEvents(e,s){e.on(t.PointerEvent.DOWN,(i=>{const{x:n,y:o}=e,l=i.getPagePoint(),h={x:n,y:o},r={side:null,spaced:null},d=this.app.on_(t.PointerEvent.MOVE,(e=>{const t=e.getPagePoint();(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),this.handleEdgeMove(h,l,t,s,r)}));e.on(t.PointerEvent.UP,(()=>{this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds),this.app.off_(d),e.off(t.PointerEvent.UP),e.off(t.PointerEvent.DOWN)}))}))}addMidEvents(e,s){e.on(t.PointerEvent.DOWN,(i=>{const{x:n,y:o}=e,l=i.getPagePoint(),h={x:n,y:o},r={index:s,pre:null,next:null},d=this.app.on_(t.PointerEvent.MOVE,(e=>{const t=e.getPagePoint();(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),this.handleMidMove(h,l,t,r)}));e.on(t.PointerEvent.UP,(()=>{this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds),this.app.off_(d),e.off(t.PointerEvent.UP),e.off(t.PointerEvent.DOWN)}))}))}handleEdgeMove(e,t,s,i,n){const{x:o,y:l}=s,{points:h}=this.selectItem,{x:r,y:d}=e,{x:p,y:a}=t,x=0===i,c={x:r+o-p,y:d+l-a};2===h.length?this.handleTwoPoints(x,c,h,n):this.handleMultiPoints(x,c,h,n)}handleTwoPoints(e,t,s,i){const n=y(s[0],s[1]),o=e?s[1]:s[0],h=n?"x":"y",r=n?"y":"x",d=e?0:s.length-1,p=Math.abs(t[r]-o[r]),a=[],x=[];if(!(Math.abs(t[h]-o[h])<l)){if(p<l)x.push({index:d,x:n?t.x:o.x,y:n?o.y:t.y});else{const{side:r,spaced:p}=i;if(x.push({index:d,x:t.x,y:t.y}),r)i.side=null,a.push({x:n?t.x:r.x,y:n?r.y:t.y});else{const r=p?p[h]:(s[0][h]+s[1][h])/2;if(Math.abs(r-t[h])<l)return;const d={x:n?r:t.x,y:n?t.y:r},x={x:n?r:o.x,y:n?o.y:r};i.spaced=null,e?a.push(d,x):a.push(x,d)}}x.length&&(g(this.selectItem,x),g(this.line,x)),a.length&&(f(this.selectItem,a,1),f(this.line,a,1))}}handleMultiPoints(e,t,s,i){const{side:n,spaced:o}=i,h=s.length,r=e?s[0]:s.at(-1),d=e?s[1]:s.at(-2),p=e?s[2]:s.at(-3),a=e?s[3]:s.at(-4),x=y(r,d),c=e?0:h-1,E=e?1:h-2,P=x?"x":"y",m=x?"y":"x",v=Math.abs(t[m]-d[m]),w=Math.abs(t[P]-d[P]),b=Math.abs(t[m]-p[m]),W=Math.abs(t[P]-p[P]),O=[],I=[];let M=null;if(!(b<l&&W<l)){if(a){const e=Math.abs(t[m]-a[m]),s=Math.abs(t[P]-a[P]);if(e<l&&s<l)return}if(n||o){if(w<l)return;if(v<l)I.push({index:c,x:x?t.x:d.x,y:x?d.y:t.y});else if(I.push({index:c,x:t.x,y:t.y}),n)i.side=null,O.push({x:x?t.x:n.x,y:x?n.y:t.y});else{if(Math.abs(o[P]-t[P])<l)return;const s={x:x?o.x:t.x,y:x?t.y:o.y},n={x:x?o.x:d.x,y:x?d.y:o.y};i.spaced=null,e?O.push(s,n):O.push(n,s)}}else if(w<l)I.push({index:c,x:x?d.x:t.x,y:x?t.y:d.y}),i.side={x:x?d.x:t.x,y:x?t.y:d.y},M={index:E,count:1};else if(b<l){const s=e?1:h-3||1,n=3===h?1:2;I.push({index:c,x:x?t.x:p.x,y:x?p.y:t.y}),i.spaced={x:x?d.x:p.x,y:x?p.y:d.y},M={index:s,count:n}}else I.push({index:c,x:t.x,y:t.y},{index:E,x:x?d.x:t.x,y:x?t.y:d.y});if(I.length&&(g(this.line,I),g(this.selectItem,I)),O.length){const t=e?1:h-1;f(this.selectItem,O,t),f(this.line,O,t)}if(M){const{index:e,count:t}=M;u(this.selectItem,e,t),u(this.line,e,t)}}}handleMidMove(e,t,s,i){const{x:n,y:o}=s,l=this.selectItem.points,h=l.length,{index:r}=i,{x:d,y:p}=e,{x:a,y:x}=t,c={x:d+n-a,y:p+o-x};0===r||r===h-2?this.handleEdgeLine(c,l,i):this.handleOtherLine(c,l,i)}handleEdgeLine(e,t,s){const{pre:i,next:n,index:o}=s,h=Object.assign({},s),r=t.length,d=2===r||0===o?t[0]:t[r-2],p=2===r||0===o?t[1]:t[r-1],a=y(d,p),x=a?"y":"x",c=Math.abs(e[x]-d[x]),E=Math.abs(e[x]-p[x]),u=[],P=[];if(!(c<l||E<l)&&(i?(h.index+=2,h.pre=null,u.push({x:a?i.x:d.x,y:a?d.y:i.y},{x:a?i.x:e.x,y:a?e.y:i.y})):0===o?(h.index+=1,u.push({x:a?d.x:e.x,y:a?e.y:d.y})):P.push({index:r-2,x:a?d.x:e.x,y:a?e.y:d.y}),n?(h.next=null,u.push({x:a?n.x:e.x,y:a?e.y:n.y},{x:a?n.x:p.x,y:a?p.y:n.y})):o===r-2?u.push({x:a?p.x:e.x,y:a?e.y:p.y}):P.push({index:1,x:a?p.x:e.x,y:a?e.y:p.y}),s.pre=h.pre,s.next=h.next,s.index=h.index,P.length&&(g(this.selectItem,P),g(this.line,P)),u.length)){const e=0===o?1:r-1;f(this.selectItem,u,e),f(this.line,u,e)}}handleOtherLine(e,t,s){const{pre:i,next:n,index:o}=s,h=Object.assign({},s),r=t.length,d=t[o-1],p=t[o],a=t[o+1],x=t[o+2],c=y(p,a),E=c?"x":"y",P=c?"y":"x",m=Math.abs(e[P]-d[P]),v=Math.abs(e[P]-x[P]),w=[],b=[],W={preCount:0,nextCount:0};if(i){const t=Math.abs(e[P]-p[P]);if(v>=l&&t<l)return;const s=v<l?x:e;h.index+=2,h.pre=null,w.push({x:c?i.x:p.x,y:c?p.y:i.y},{x:c?i.x:s.x,y:c?s.y:i.y})}else if(m<l&&m<=v){const t=1===o?1:2;W.preCount=t,h.index-=t,1!==o&&(h.pre={x:c?p.x:e.x,y:c?e.y:p.y})}else if(v<l){if(t[o+3]){if(Math.abs(t[o+3][E]-p[E])<l)return}b.push({index:o,x:c?p.x:x.x,y:c?x.y:p.y})}else b.push({index:o,x:c?p.x:e.x,y:c?e.y:p.y});if(n){const t=Math.abs(e[P]-a[P]);if(m>=l&&t<l)return;const s=m<l?d:e;h.next=null,w.push({x:c?n.x:s.x,y:c?s.y:n.y},{x:c?n.x:a.x,y:c?a.y:n.y})}else if(v<l&&v<=m){const t=o===r-3?1:2;W.nextCount=t,o!==r-3&&(h.next={x:c?a.x:e.x,y:c?e.y:a.y})}else if(m<l){if(t[o-2]){if(Math.abs(t[o-2][E]-a[E])<l)return}b.push({index:o+1,x:c?a.x:d.x,y:c?d.y:a.y})}else b.push({index:o+1,x:c?a.x:e.x,y:c?e.y:a.y});if(s.pre=h.pre,s.next=h.next,s.index=h.index,b.length&&(g(this.selectItem,b),g(this.line,b)),w.length&&(f(this.selectItem,w,o+1),f(this.line,w,o+1)),W.preCount||W.nextCount){const{preCount:e,nextCount:t}=W,s=e+t;let i=e?o-1||1:o+1;i>=o+1&&(i+=w.length),u(this.selectItem,i,s),u(this.line,i,s)}}redrawEllipses(){const{points:e}=this.selectItem,t=x(e);this.drawEdgeEllipses(e),this.drawMidEllipses(t)}removeEllipses(){this.edgeEllipses.forEach((e=>{e.remove()})),this.midEllipses.forEach((e=>{e.remove()})),this.edgeEllipses=[],this.midEllipses=[]}}s([t.sortType(o)],v.prototype,"zIndex",void 0),exports.FreePolylineEditor=m,exports.OrthoPolylineEditor=v;
