"use strict";var t=require("@leafer-in/arrow"),e=require("@leafer-ui/core");function s(t,e,s,i){var n,o=arguments.length,r=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,i);else for(var l=t.length-1;l>=0;l--)(n=t[l])&&(r=(o<3?n(r):o>3?n(e,s,r):n(e,s))||r);return o>3&&r&&Object.defineProperty(e,s,r),r}"function"==typeof SuppressedError&&SuppressedError;let i=class extends t.ArrowData{};function n(t){return t.length>=2}function o(t){return!(t.length<2)&&t.every(((t,e,s)=>0===e||(r(s[e-1],t)?!s[e-2]||l(s[e-2],s[e-1]):!!l(s[e-1],t)&&(!s[e-2]||r(s[e-2],s[e-1])))))}function r(t,e){return t.y===e.y&&t.x!==e.x}function l(t,e){return t.x===e.x&&t.y!==e.y}function h(t,e,s){const i=[...t.points];i.splice(s,0,...e),t.setAttr("points",i)}function x(t,e,s){const i=[...t.points];i.splice(e,s),t.setAttr("points",i)}function a(t,e){const s=[...t.points];e.forEach((t=>{const{index:e,x:i,y:n}=t;s[e]={x:i,y:n}})),t.setAttr("points",s)}function y(t,e){const s=e.map((e=>t.getInnerPoint(e)));t.setAttr("points",s)}const p="round",d="round",c="none",u="none",f=10,g={moveable:!0};exports.FreePolyline=class extends t.Arrow{get __tag(){return"FreePolyline"}constructor(t){if(super(t),!n(this.points)){const e=JSON.stringify(t);throw new Error(`Params points can't paint an orthogonal polylines!\n${e}`)}}},s([e.dataProcessor(i)],exports.FreePolyline.prototype,"__",void 0),s([e.boundsType(p)],exports.FreePolyline.prototype,"strokeCap",void 0),s([e.boundsType(d)],exports.FreePolyline.prototype,"strokeJoin",void 0),s([e.boundsType(c)],exports.FreePolyline.prototype,"startArrow",void 0),s([e.boundsType(u)],exports.FreePolyline.prototype,"endArrow",void 0),s([e.createAttr(g)],exports.FreePolyline.prototype,"editConfig",void 0),exports.FreePolyline=s([e.registerUI()],exports.FreePolyline);class E extends t.ArrowData{set editConfig(t){this._editConfig=Object.assign(Object.assign({},g),t)}}exports.OrthoPolyline=class extends t.Arrow{get __tag(){return"OrthoPolyline"}constructor(t){if(super(t),!o(this.points)){const e=JSON.stringify(t);throw new Error(`Params points can't paint an orthogonal polylines!\n${e}`)}}setStart(t){const{points:e}=this,s=[...e],i=s[0],n=s[1],o=r(i,n);if(2===s.length){const t=o?(i.x+n.x)/2:(i.y+n.y)/2;s.splice(1,0,{x:o?t:i.x,y:o?i.y:t},{x:o?t:n.x,y:o?n.y:t})}else{const e=s[2];i.x=t.x===e.x?t.x+1e-6:t.x,i.y=t.y===e.y?t.y+1e-6:t.y,s[1]={x:o?n.x:i.x,y:o?i.y:n.y}}this.setAttr("points",s)}setEnd(t){const{points:e}=this,s=[...e],i=s.at(-1),n=s.at(-2),o=r(i,n);if(2===s.length){const t=o?(i.x+n.x)/2:(i.y+n.y)/2;s.splice(-1,0,{x:o?t:n.x,y:o?n.y:t},{x:o?t:i.x,y:o?i.y:t})}else{const e=s.at(-3);i.x=t.x===e.x?t.x+1e-6:t.x,i.y=t.y===e.y?t.y+1e-6:t.y,s[s.length-2]={x:o?n.x:i.x,y:o?i.y:n.y}}this.setAttr("points",s)}},s([e.dataProcessor(E)],exports.OrthoPolyline.prototype,"__",void 0),s([e.strokeType(p)],exports.OrthoPolyline.prototype,"strokeCap",void 0),s([e.strokeType(d)],exports.OrthoPolyline.prototype,"strokeJoin",void 0),s([t.arrowType(c)],exports.OrthoPolyline.prototype,"startArrow",void 0),s([t.arrowType(u)],exports.OrthoPolyline.prototype,"endArrow",void 0),s([e.dataType(g)],exports.OrthoPolyline.prototype,"editConfig",void 0),exports.OrthoPolyline=s([e.registerUI()],exports.OrthoPolyline);class m extends e.GroupData{}function b(t,e){const s=t[e],i=t[e+1];return r(s,i)?Math.abs(s.x-i.x)>=20:Math.abs(s.y-i.y)>=20}function v(t,e,s,i){const{points:n}=s;2===n.length?function(t,e,s,i,n){const{index:o,side:l,spaced:x,length:p}=s,d=0===o,c=r(e[0],e[1]),u=d?e[1]:e[0],g=c?"x":"y",E=c?"y":"x",m=d?0:e.length-1,b=Math.abs(t[E]-u[E]),v=Math.abs(t[g]-u[g]),P=[],w=[];if(v<f)return;if(b<f)w.push({index:m,x:c?t.x:u.x,y:c?u.y:t.y});else if(w.push({index:m,x:t.x,y:t.y}),l)s.side=null,P.push({x:c?t.x:l.x,y:c?l.y:t.y});else{const i=x?x[g]:(e[0][g]+e[1][g])/2;if(Math.abs(i-t[g])<f)return;const n={x:c?i:t.x,y:c?t.y:i},o={x:c?i:u.x,y:c?u.y:i};s.spaced=null,d?3===p?P.push(n):P.push(n,o):3===p?P.push(n):P.push(o,n)}w.length&&(a(i,w),y(n,i.points));P.length&&(h(i,P,1),y(n,i.points))}(t,n,e,s,i):function(t,e,s,i,n){const{index:o,side:l,spaced:p}=s,d=0===o,c=e.length,u=d?e[0]:e.at(-1),g=d?e[1]:e.at(-2),E=d?e[2]:e.at(-3),m=d?e[3]:e.at(-4),b=r(u,g),v=d?0:c-1,P=d?1:c-2,w=b?"x":"y",A=b?"y":"x",D=Math.abs(t[A]-g[A]),O=Math.abs(t[w]-g[w]),I=Math.abs(t[A]-E[A]),M=Math.abs(t[w]-E[w]),k=[],F=[];let C=null;if(I<f&&M<f)return;if(m){const e=Math.abs(t[A]-m[A]),s=Math.abs(t[w]-m[w]);if(e<f&&s<f)return}if(l||p){if(O<f)return;if(D<f)F.push({index:v,x:b?t.x:g.x,y:b?g.y:t.y});else if(F.push({index:v,x:t.x,y:t.y}),l)s.side=null,k.push({x:b?t.x:l.x,y:b?l.y:t.y});else{if(Math.abs(p[w]-t[w])<f)return;const e={x:b?p.x:t.x,y:b?t.y:p.y},i={x:b?p.x:g.x,y:b?g.y:p.y};s.spaced=null,d?k.push(e,i):k.push(i,e)}}else if(O<f)F.push({index:v,x:b?g.x:t.x,y:b?t.y:g.y}),s.side={x:b?g.x:t.x,y:b?t.y:g.y},C={index:P,count:1};else if(I<f){const e=d?1:c-3||1,i=3===c?1:2;F.push({index:v,x:b?t.x:E.x,y:b?E.y:t.y}),s.length=c,s.spaced={x:b?g.x:E.x,y:b?E.y:g.y},C={index:e,count:i}}else F.push({index:v,x:t.x,y:t.y},{index:P,x:b?g.x:t.x,y:b?t.y:g.y});F.length&&(a(i,F),y(n,i.points));if(k.length){h(i,k,d?1:c-1),y(n,i.points)}if(C){const{index:t,count:e}=C;x(n,t,e),x(i,t,e)}}(t,n,e,s,i)}function P(t,e,s,i){const{points:n}=s,o=n.length,{index:l}=e;0===l||l===o-2?function(t,e,s,i,n){const{pre:o,next:l,index:x}=s,p=Object.assign({},s),d=e.length,c=2===d||0===x?e[0]:e[d-2],u=2===d||0===x?e[1]:e[d-1],g=r(c,u),E=g?"y":"x",m=Math.abs(t[E]-c[E]),b=Math.abs(t[E]-u[E]),v=[],P=[];if(m<f||b<f)return;o?(p.index+=2,p.pre=null,v.push({x:g?o.x:c.x,y:g?c.y:o.y},{x:g?o.x:t.x,y:g?t.y:o.y})):0===x?(p.index+=1,v.push({x:g?c.x:t.x,y:g?t.y:c.y})):P.push({index:d-2,x:g?c.x:t.x,y:g?t.y:c.y});l?(p.next=null,v.push({x:g?l.x:t.x,y:g?t.y:l.y},{x:g?l.x:u.x,y:g?u.y:l.y})):x===d-2?v.push({x:g?u.x:t.x,y:g?t.y:u.y}):P.push({index:1,x:g?u.x:t.x,y:g?t.y:u.y});s.pre=p.pre,s.next=p.next,s.index=p.index,P.length&&(a(i,P),y(n,i.points));if(v.length){h(i,v,0===x?1:d-1),y(n,i.points)}}(t,n,e,s,i):function(t,e,s,i,n){const{pre:o,next:l,index:p}=s,d=Object.assign({},s),c=e.length,u=e[p-1],g=e[p],E=e[p+1],m=e[p+2],b=r(g,E),v=b?"x":"y",P=b?"y":"x",w=Math.abs(t[P]-u[P]),A=Math.abs(t[P]-m[P]),D=[],O=[],I={preCount:0,nextCount:0};if(o){const e=Math.abs(t[P]-g[P]);if(A>=f&&e<f)return;const s=A<f?m:t;d.index+=2,d.pre=null,D.push({x:b?o.x:g.x,y:b?g.y:o.y},{x:b?o.x:s.x,y:b?s.y:o.y})}else if(w<f&&w<=A){const e=1===p?1:2;I.preCount=e,d.index-=e,1!==p&&(d.pre={x:b?g.x:t.x,y:b?t.y:g.y})}else if(A<f){if(e[p+3]){if(Math.abs(e[p+3][v]-g[v])<f)return}O.push({index:p,x:b?g.x:m.x,y:b?m.y:g.y})}else O.push({index:p,x:b?g.x:t.x,y:b?t.y:g.y});if(l){const e=Math.abs(t[P]-E[P]);if(w>=f&&e<f)return;const s=w<f?u:t;d.next=null,D.push({x:b?l.x:s.x,y:b?s.y:l.y},{x:b?l.x:E.x,y:b?E.y:l.y})}else if(A<f&&A<=w){const e=p===c-3?1:2;I.nextCount=e,p!==c-3&&(d.next={x:b?E.x:t.x,y:b?t.y:E.y})}else if(w<f){if(e[p-2]){if(Math.abs(e[p-2][v]-E[v])<f)return}O.push({index:p+1,x:b?E.x:u.x,y:b?u.y:E.y})}else O.push({index:p+1,x:b?E.x:t.x,y:b?t.y:E.y});s.pre=d.pre,s.next=d.next,s.index=d.index,O.length&&(a(i,O),y(n,i.points));D.length&&(h(i,D,p+1),y(n,i.points));if(I.preCount||I.nextCount){const{preCount:t,nextCount:e}=I,s=t+e;let o=t?p-1||1:p+1;o>=p+1&&(o+=D.length),x(n,o,s),x(i,o,s)}}(t,n,e,s,i)}function w(t,e){const s=t[e],i=t[e+1];return Math.abs(s.x-i.x)>=20||Math.abs(s.y-i.y)>=20}class A extends e.Group{constructor(t){super(t),this.line=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}get __tag(){return"PolylineEditor"}initEvents(){this.waitLeafer((()=>{const{isApp:t,sky:s}=this.app;if(!t||this.parent!==s)throw new Error("PolylineEditor must be added to the zoomLayer of the App!");this.app.on(e.PointerEvent.DOWN,this.downHandler.bind(this)),this.app.on(e.PointerEvent.DOUBLE_TAP,this.doubleTapHandler.bind(this)),this.app.on(e.ZoomEvent.ZOOM,this.redrawEditor.bind(this)),this.app.on(e.MoveEvent.MOVE,this.redrawEditor.bind(this))}))}downHandler(t){if("normal"!==this.app.mode)return;if(![1,2].includes(t.buttons))return;const e=t.target;e.parent!==this&&this.select(e)}doubleTapHandler(t){if("normal"!==this.app.mode)return;if(!this.selectItem)return;t.target.parent!==this&&this.emit("double-tap",{target:this.selectItem})}drawEditor(){const{points:t,editConfig:e}=this.selectItem,{moveable:s}=e,i=t.map((t=>this.selectItem.getWorldPoint(t)));if(this.drawLine(i),s){const t=function(t){return t.reduce(((t,e,s,i)=>(s>0&&t.push({x:(i[s-1].x+e.x)/2,y:(i[s-1].y+e.y)/2}),t)),[])}(i);this.drawEdgeEllipses(i),this.drawMidEllipses(t)}}clearEditor(){this.edgeEllipses.forEach((t=>{t.off(e.DragEvent.DRAG),t.off(e.DragEvent.END),t.destroy()})),this.midEllipses.forEach((t=>{t.off(e.DragEvent.DRAG),t.off(e.DragEvent.END),t.destroy()})),this.line&&(this.line.destroy(),this.line=null),this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawLine(t){const{color:s,strokeWidth:i}=this;this.line=new e.Line({points:t,hittable:!1,name:"editor-line",stroke:s,strokeWidth:i,strokeCap:p,strokeJoin:d}),this.add(this.line)}drawEdgeEllipses(t){const{tag:s}=this.selectItem,i="FreePolyline"===s?t:[t[0],t.at(-1)],{color:n,ellipseWidth:o,strokeWidth:r}=this;i.forEach(((t,s)=>{const i=new e.Ellipse({width:o,height:o,x:t.x,y:t.y,draggable:!0,name:"polyline-editor-point-"+(0===s?"start":"end"),around:"center",stroke:n,strokeWidth:r,strokeAlign:"center",fill:"#fff"});this.edgeEllipses.push(i),this.addEdgeEvents(i,s)})),this.add(this.edgeEllipses)}drawMidEllipses(t){const{tag:s}=this.selectItem,i=this.line.points,{color:n,ellipseWidth:o,strokeWidth:r}=this;t.forEach(((t,l)=>{const h=new e.Ellipse({width:o,height:o,x:t.x,y:t.y,draggable:!0,name:"polyline-editor-point",around:"center",stroke:"#fff",strokeWidth:r-1,strokeAlign:"center",fill:n,visible:"OrthoPolyline"===s?b(i,l):w(i,l)});this.midEllipses.push(h),this.addMidEvents(h,l)})),this.add(this.midEllipses)}addEdgeEvents(t,s){const{tag:i}=this.selectItem,n={length:this.line.points.length,index:s,side:null,spaced:null};t.on(e.DragEvent.START,(e=>{this.hideEllipses(),this.emit("drag-start",{target:this.selectItem,current:t})})),t.on(e.DragEvent.DRAG,(e=>{const{x:s,y:o}=t,r={x:s,y:o};"OrthoPolyline"===i?v(r,n,this.line,this.selectItem):"FreePolyline"===i&&function(t,e,s,i){const{index:n}=e;a(s,[{index:n,x:t.x,y:t.y}]),y(i,s.points)}(r,n,this.line,this.selectItem),this.emit("drag",{target:this.selectItem,current:t})})),t.on(e.DragEvent.END,(s=>{t.off(e.DragEvent.DRAG),t.off(e.DragEvent.END),this.redrawEditor(),this.emit("drag-end",{target:this.selectItem,current:t})}))}addMidEvents(t,s){const{tag:i}=this.selectItem,n={length:this.line.points.length,index:s,pre:null,next:null};t.on(e.DragEvent.START,(e=>{this.hideEllipses(),this.emit("drag-start",{target:this.selectItem,current:t})})),t.on(e.DragEvent.DRAG,(e=>{const{x:s,y:o}=t,r={x:s,y:o};"OrthoPolyline"===i?P(r,n,this.line,this.selectItem):"FreePolyline"===i&&function(t,e,s,i){const{length:n,index:o}=e,r={x:t.x,y:t.y},l=Object.assign(Object.assign({},r),{index:o+1});n===s.points.length?(h(s,[r],o+1),y(i,s.points)):(a(s,[l]),y(i,s.points))}(r,n,this.line,this.selectItem),this.emit("drag",{target:this.selectItem,current:t})})),t.on(e.DragEvent.END,(s=>{t.off(e.DragEvent.DRAG),t.off(e.DragEvent.END),this.redrawEditor(),this.emit("drag-end",{target:this.selectItem,current:t})}))}redrawEditor(){this.selectItem&&(this.clearEditor(),this.drawEditor())}hideEllipses(){this.edgeEllipses.forEach((t=>{t.setAttr("visible",!1)})),this.midEllipses.forEach((t=>{t.setAttr("visible",!1)}))}select(t){if(t===this.selectItem)return;const e=this.selectItem;this.selectItem&&(this.clearEditor(),this.selectItem=null),["OrthoPolyline","FreePolyline"].includes(t.tag)&&(this.selectItem=t,this.drawEditor()),this.emit("select",{oldValue:e,value:this.selectItem})}cancel(){this.clearEditor(),this.emit("select",{oldValue:this.selectItem,value:null})}}s([e.dataProcessor(m)],A.prototype,"__",void 0),s([e.createAttr("#1890FF")],A.prototype,"color",void 0),s([e.createAttr(2)],A.prototype,"strokeWidth",void 0),s([e.createAttr(10)],A.prototype,"ellipseWidth",void 0),exports.PolylineEditor=A,exports.isFreeLine=n,exports.isHorizon=r,exports.isOrthoLine=o,exports.isVertical=l;
