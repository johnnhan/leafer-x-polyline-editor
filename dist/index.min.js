this.LeaferX=this.LeaferX||{},this.LeaferX.PolylineEditor=function(e,t,s){"use strict";function i(e,t,s,i){var n,o=arguments.length,l=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,s,i);else for(var h=e.length-1;h>=0;h--)(n=e[h])&&(l=(o<3?n(l):o>3?n(t,s,l):n(t,s))||l);return o>3&&l&&Object.defineProperty(t,s,l),l}"function"==typeof SuppressedError&&SuppressedError;class n extends t.ArrowData{}const o="#1890FF",l=99999999,h=10,r="round",d="round",a="none",p="none";e.FreePolyline=class extends t.Arrow{get __tag(){return"FreePolyline"}constructor(e){super(e)}},i([s.boundsType(r)],e.FreePolyline.prototype,"strokeCap",void 0),i([s.boundsType(d)],e.FreePolyline.prototype,"strokeJoin",void 0),i([s.boundsType(a)],e.FreePolyline.prototype,"startArrow",void 0),i([s.boundsType(p)],e.FreePolyline.prototype,"endArrow",void 0),i([s.dataProcessor(n)],e.FreePolyline.prototype,"__",void 0),e.FreePolyline=i([s.registerUI()],e.FreePolyline);class c extends t.ArrowData{}function x(e){return e.reduce(((e,t,s,i)=>(s>0&&e.push({x:(i[s-1].x+t.x)/2,y:(i[s-1].y+t.y)/2}),e)),[])}function y(e){return e.length?function(e){return e.length&&"object"==typeof e[0]}(e)?e:e.reduce(((e,t,s,i)=>(s%2&&e.push({x:i[s-1],y:t}),e)),[]):e}function E(e,t){return e.y===t.y&&e.x!==t.x}function f(e,t){return e.x===t.x&&e.y!==t.y}function u(e,t,s){const i=[...e.points];i.splice(s,0,...t),e.setAttr("points",i)}function g(e,t,s){const i=[...e.points];i.splice(t,s),e.setAttr("points",i)}function P(e,t){const s=[...e.points];t.forEach((e=>{const{index:t,x:i,y:n}=e;s[t]={x:i,y:n}})),e.setAttr("points",s)}function m(e,t){const s=e[t],i=e[t+1];return E(s,i)?Math.abs(s.x-i.x)>=20:Math.abs(s.y-i.y)>=20}e.OrthoPolyline=class extends t.Arrow{get __tag(){return"OrthoPolyline"}constructor(e){if(super(e),!this.isOrthoLine(y(this.points)))throw new Error("Params points can't paint an orthogonal polylines!")}isOrthoLine(e){return!(e.length<2)&&e.every(((e,t,s)=>0===t||(E(s[t-1],e)?!s[t-2]||f(s[t-2],s[t-1]):!!f(s[t-1],e)&&(!s[t-2]||E(s[t-2],s[t-1])))))}},i([s.boundsType(r)],e.OrthoPolyline.prototype,"strokeCap",void 0),i([s.boundsType(d)],e.OrthoPolyline.prototype,"strokeJoin",void 0),i([s.boundsType(a)],e.OrthoPolyline.prototype,"startArrow",void 0),i([s.boundsType(p)],e.OrthoPolyline.prototype,"endArrow",void 0),i([s.dataProcessor(c)],e.OrthoPolyline.prototype,"__",void 0),e.OrthoPolyline=i([s.registerUI()],e.OrthoPolyline);class v extends s.Group{constructor(e={}){const{color:t,strokeWidth:s,ellipseWidth:i}=e;super(),this.color=null!=t?t:o,this.strokeWidth=null!=s?s:2,this.ellipseWidth=null!=i?i:10,this.line=null,this.rect=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}initEvents(){this.waitLeafer((()=>{const{isApp:e,zoomLayer:t}=this.app;if(!e||!t||t!=this.parent)throw new Error("FreePolylineEditor must be added to the zoomLayer of the App!");this.app.on(s.PointerEvent.DOWN,this.downHandler.bind(this)),this.app.on(s.ZoomEvent.ZOOM,this.zoomHandler.bind(this))}))}downHandler(e){const t=e.target;t!==this.selectItem&&t.parent!==this&&(this.selectItem&&(this.selectItem=null,this.clearEditor()),"FreePolyline"===t.tag&&(this.set({x:t.x,y:t.y}),this.selectItem=t,this.drawEditor()))}zoomHandler(){if(!this.selectItem)return;const{scale:e}=this.leafer,t=this.strokeWidth/e,s=this.ellipseWidth/e;this.line.setAttr("strokeWidth",t),this.edgeEllipses.forEach((e=>{e.set({width:s,height:s,strokeWidth:t})})),this.midEllipses.forEach((e=>{e.set({width:s,height:s,strokeWidth:t})}))}drawEditor(){const{points:e}=this.selectItem,t=y(e),s=x(t);this.drawLine(t),this.drawRect(),this.drawEdgeEllipses(t),this.drawMidEllipses(s)}clearEditor(){this.edgeEllipses.forEach((e=>{e.off(s.PointerEvent.DOWN)})),this.midEllipses.forEach((e=>{e.off(s.PointerEvent.DOWN)})),this.rect.off(s.PointerEvent.DOWN),this.line=null,this.rect=null,this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawRect(){const{x:e,y:t,width:i,height:n}=this.selectItem.boxBounds;this.rect=new s.Rect({y:t,x:e,width:i,height:n,fill:"rgba(0, 0, 0, 0)"}),this.add(this.rect),this.addRectEvents(this.rect)}drawLine(e){const{scale:t}=this.leafer,i=this.strokeWidth/t;this.line=new s.Line({points:e,stroke:this.color,strokeWidth:i}),this.add(this.line)}drawEdgeEllipses(e){const{scale:t}=this.leafer,i=this.ellipseWidth/t,n=this.strokeWidth/t;e.forEach(((e,t)=>{const o=new s.Ellipse({width:i,height:i,x:e.x,y:e.y,around:"center",stroke:this.color,strokeWidth:n,fill:"#fff",draggable:!0});this.edgeEllipses.push(o),this.addEdgeEvents(o,t)})),this.add(this.edgeEllipses)}drawMidEllipses(e){const{scale:t}=this.leafer,i=this.ellipseWidth/t,n=this.strokeWidth/t,{points:o}=this.selectItem;e.forEach(((e,t)=>{const l=new s.Ellipse({width:i,height:i,x:e.x,y:e.y,around:"center",stroke:"#fff",strokeWidth:n,fill:this.color,visible:m(o,t)});this.midEllipses.push(l),this.addMidEvents(l,t)})),this.add(this.midEllipses)}addRectEvents(e){e.on(s.PointerEvent.DOWN,(t=>{const{x:i,y:n}=this.selectItem,{x:o,y:l}=t.getPagePoint(),h=this.app.on_(s.PointerEvent.MOVE,(e=>{const{x:t,y:s}=e.getPagePoint();this.selectItem.set({x:i+t-o,y:n+s-l}),this.set({x:i+t-o,y:n+s-l})}));e.on(s.PointerEvent.UP,(()=>{this.app.off_(h),e.off(s.PointerEvent.UP)}))}))}addEdgeEvents(e,t){e.on(s.PointerEvent.DOWN,(i=>{const{x:n,y:o}=e,{x:l,y:h}=i.getPagePoint(),r=this.app.on_(s.PointerEvent.MOVE,(e=>{const{x:s,y:i}=e.getPagePoint(),r={index:t,x:n+s-l,y:o+i-h};(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),P(this.line,[r]),P(this.selectItem,[r])}));e.on(s.PointerEvent.UP,(()=>{this.app.off_(r),e.off(s.PointerEvent.UP),e.off(s.PointerEvent.DOWN),this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds)}))}))}addMidEvents(e,t){e.on(s.PointerEvent.DOWN,(i=>{const{x:n,y:o}=e,{x:l,y:h}=i.getPagePoint();let r=!1;const d=this.app.on_(s.PointerEvent.MOVE,(e=>{const{x:s,y:i}=e.getPagePoint(),d={x:n+s-l,y:o+i-h},a=Object.assign(Object.assign({},d),{index:t+1});(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),r?(P(this.line,[a]),P(this.selectItem,[a])):(r=!0,u(this.line,[d],t+1),u(this.selectItem,[d],t+1))}));e.on(s.PointerEvent.UP,(()=>{this.app.off_(d),e.off(s.PointerEvent.UP),e.off(s.PointerEvent.DOWN),this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds)}))}))}redrawEllipses(){const{points:e}=this.selectItem,t=x(e);this.drawEdgeEllipses(e),this.drawMidEllipses(t)}removeEllipses(){this.edgeEllipses.forEach((e=>{e.remove()})),this.midEllipses.forEach((e=>{e.remove()})),this.edgeEllipses=[],this.midEllipses=[]}}i([s.sortType(l)],v.prototype,"zIndex",void 0);class w extends s.Group{constructor(e={}){const{color:t,strokeWidth:s,ellipseWidth:i}=e;super(),this.color=null!=t?t:o,this.strokeWidth=null!=s?s:2,this.ellipseWidth=null!=i?i:10,this.line=null,this.rect=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}initEvents(){this.waitLeafer((()=>{const{isApp:e,zoomLayer:t}=this.app;if(!e||!t||t!=this.parent)throw new Error("OrthoPolylineEditor must be added to the zoomLayer of the App!");this.app.on(s.PointerEvent.DOWN,this.downHandler.bind(this)),this.app.on(s.ZoomEvent.ZOOM,this.zoomHandler.bind(this))}))}downHandler(e){const t=e.target;t!==this.selectItem&&t.parent!==this&&(this.selectItem&&(this.selectItem=null,this.clearEditor()),"OrthoPolyline"===t.tag&&(this.set({x:t.x,y:t.y}),this.selectItem=t,this.drawEditor()))}zoomHandler(){if(!this.selectItem)return;const{scale:e}=this.leafer,t=this.strokeWidth/e,s=this.ellipseWidth/e;this.line.setAttr("strokeWidth",t),this.edgeEllipses.forEach((e=>{e.set({width:s,height:s,strokeWidth:t})})),this.midEllipses.forEach((e=>{e.set({width:s,height:s,strokeWidth:t})}))}drawEditor(){const{points:e}=this.selectItem,t=y(e),s=x(t);this.drawLine(t),this.drawRect(),this.drawEdgeEllipses(t),this.drawMidEllipses(s)}clearEditor(){this.edgeEllipses.forEach((e=>{e.off(s.PointerEvent.DOWN)})),this.midEllipses.forEach((e=>{e.off(s.PointerEvent.DOWN)})),this.rect.off(s.PointerEvent.DOWN),this.line=null,this.rect=null,this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawRect(){const{x:e,y:t,width:i,height:n}=this.selectItem.boxBounds;this.rect=new s.Rect({y:t,x:e,width:i,height:n,fill:"rgba(0, 0, 0, 0)"}),this.add(this.rect),this.addRectEvents(this.rect)}drawLine(e){const{scale:t}=this.leafer,i=this.strokeWidth/t;this.line=new s.Line({points:e,stroke:this.color,strokeWidth:i}),this.add(this.line)}drawEdgeEllipses(e){const{scale:t}=this.leafer,i=this.ellipseWidth/t,n=this.strokeWidth/t;[e[0],e.at(-1)].forEach(((e,t)=>{const o=new s.Ellipse({width:i,height:i,x:e.x,y:e.y,around:"center",stroke:this.color,strokeWidth:n,fill:"#fff"});this.edgeEllipses.push(o),this.addEdgeEvents(o,t)})),this.add(this.edgeEllipses)}drawMidEllipses(e){const{scale:t}=this.leafer,i=this.ellipseWidth/t,n=this.strokeWidth/t,{points:o}=this.selectItem;e.forEach(((e,t)=>{const l=new s.Ellipse({width:i,height:i,x:e.x,y:e.y,around:"center",stroke:"#fff",strokeWidth:n,fill:this.color,visible:m(o,t)});this.midEllipses.push(l),this.addMidEvents(l,t)})),this.add(this.midEllipses)}addRectEvents(e){e.on(s.PointerEvent.DOWN,(t=>{const{x:i,y:n}=this.selectItem,{x:o,y:l}=t.getPagePoint(),h=this.app.on_(s.PointerEvent.MOVE,(e=>{const{x:t,y:s}=e.getPagePoint();this.selectItem.set({x:i+t-o,y:n+s-l}),this.set({x:i+t-o,y:n+s-l})}));e.on(s.PointerEvent.UP,(()=>{this.app.off_(h),e.off(s.PointerEvent.UP)}))}))}addEdgeEvents(e,t){e.on(s.PointerEvent.DOWN,(i=>{const{x:n,y:o}=e,l=i.getPagePoint(),h={x:n,y:o},r={side:null,spaced:null},d=this.app.on_(s.PointerEvent.MOVE,(e=>{const s=e.getPagePoint();(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),this.handleEdgeMove(h,l,s,t,r)}));e.on(s.PointerEvent.UP,(()=>{this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds),this.app.off_(d),e.off(s.PointerEvent.UP),e.off(s.PointerEvent.DOWN)}))}))}addMidEvents(e,t){e.on(s.PointerEvent.DOWN,(i=>{const{x:n,y:o}=e,l=i.getPagePoint(),h={x:n,y:o},r={index:t,pre:null,next:null},d=this.app.on_(s.PointerEvent.MOVE,(e=>{const t=e.getPagePoint();(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),this.handleMidMove(h,l,t,r)}));e.on(s.PointerEvent.UP,(()=>{this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds),this.app.off_(d),e.off(s.PointerEvent.UP),e.off(s.PointerEvent.DOWN)}))}))}handleEdgeMove(e,t,s,i,n){const{x:o,y:l}=s,{points:h}=this.selectItem,{x:r,y:d}=e,{x:a,y:p}=t,c=0===i,x={x:r+o-a,y:d+l-p};2===h.length?this.handleTwoPoints(c,x,h,n):this.handleMultiPoints(c,x,h,n)}handleTwoPoints(e,t,s,i){const n=E(s[0],s[1]),o=e?s[1]:s[0],l=n?"x":"y",r=n?"y":"x",d=e?0:s.length-1,a=Math.abs(t[r]-o[r]),p=[],c=[];if(!(Math.abs(t[l]-o[l])<h)){if(a<h)c.push({index:d,x:n?t.x:o.x,y:n?o.y:t.y});else{const{side:r,spaced:a}=i;if(c.push({index:d,x:t.x,y:t.y}),r)i.side=null,p.push({x:n?t.x:r.x,y:n?r.y:t.y});else{const r=a?a[l]:(s[0][l]+s[1][l])/2;if(Math.abs(r-t[l])<h)return;const d={x:n?r:t.x,y:n?t.y:r},c={x:n?r:o.x,y:n?o.y:r};i.spaced=null,e?p.push(d,c):p.push(c,d)}}c.length&&(P(this.selectItem,c),P(this.line,c)),p.length&&(u(this.selectItem,p,1),u(this.line,p,1))}}handleMultiPoints(e,t,s,i){const{side:n,spaced:o}=i,l=s.length,r=e?s[0]:s.at(-1),d=e?s[1]:s.at(-2),a=e?s[2]:s.at(-3),p=e?s[3]:s.at(-4),c=E(r,d),x=e?0:l-1,y=e?1:l-2,f=c?"x":"y",m=c?"y":"x",v=Math.abs(t[m]-d[m]),w=Math.abs(t[f]-d[f]),b=Math.abs(t[m]-a[m]),W=Math.abs(t[f]-a[f]),O=[],I=[];let M=null;if(!(b<h&&W<h)){if(p){const e=Math.abs(t[m]-p[m]),s=Math.abs(t[f]-p[f]);if(e<h&&s<h)return}if(n||o){if(w<h)return;if(v<h)I.push({index:x,x:c?t.x:d.x,y:c?d.y:t.y});else if(I.push({index:x,x:t.x,y:t.y}),n)i.side=null,O.push({x:c?t.x:n.x,y:c?n.y:t.y});else{if(Math.abs(o[f]-t[f])<h)return;const s={x:c?o.x:t.x,y:c?t.y:o.y},n={x:c?o.x:d.x,y:c?d.y:o.y};i.spaced=null,e?O.push(s,n):O.push(n,s)}}else if(w<h)I.push({index:x,x:c?d.x:t.x,y:c?t.y:d.y}),i.side={x:c?d.x:t.x,y:c?t.y:d.y},M={index:y,count:1};else if(b<h){const s=e?1:l-3||1,n=3===l?1:2;I.push({index:x,x:c?t.x:a.x,y:c?a.y:t.y}),i.spaced={x:c?d.x:a.x,y:c?a.y:d.y},M={index:s,count:n}}else I.push({index:x,x:t.x,y:t.y},{index:y,x:c?d.x:t.x,y:c?t.y:d.y});if(I.length&&(P(this.line,I),P(this.selectItem,I)),O.length){const t=e?1:l-1;u(this.selectItem,O,t),u(this.line,O,t)}if(M){const{index:e,count:t}=M;g(this.selectItem,e,t),g(this.line,e,t)}}}handleMidMove(e,t,s,i){const{x:n,y:o}=s,l=this.selectItem.points,h=l.length,{index:r}=i,{x:d,y:a}=e,{x:p,y:c}=t,x={x:d+n-p,y:a+o-c};0===r||r===h-2?this.handleEdgeLine(x,l,i):this.handleOtherLine(x,l,i)}handleEdgeLine(e,t,s){const{pre:i,next:n,index:o}=s,l=Object.assign({},s),r=t.length,d=2===r||0===o?t[0]:t[r-2],a=2===r||0===o?t[1]:t[r-1],p=E(d,a),c=p?"y":"x",x=Math.abs(e[c]-d[c]),y=Math.abs(e[c]-a[c]),f=[],g=[];if(!(x<h||y<h)&&(i?(l.index+=2,l.pre=null,f.push({x:p?i.x:d.x,y:p?d.y:i.y},{x:p?i.x:e.x,y:p?e.y:i.y})):0===o?(l.index+=1,f.push({x:p?d.x:e.x,y:p?e.y:d.y})):g.push({index:r-2,x:p?d.x:e.x,y:p?e.y:d.y}),n?(l.next=null,f.push({x:p?n.x:e.x,y:p?e.y:n.y},{x:p?n.x:a.x,y:p?a.y:n.y})):o===r-2?f.push({x:p?a.x:e.x,y:p?e.y:a.y}):g.push({index:1,x:p?a.x:e.x,y:p?e.y:a.y}),s.pre=l.pre,s.next=l.next,s.index=l.index,g.length&&(P(this.selectItem,g),P(this.line,g)),f.length)){const e=0===o?1:r-1;u(this.selectItem,f,e),u(this.line,f,e)}}handleOtherLine(e,t,s){const{pre:i,next:n,index:o}=s,l=Object.assign({},s),r=t.length,d=t[o-1],a=t[o],p=t[o+1],c=t[o+2],x=E(a,p),y=x?"x":"y",f=x?"y":"x",m=Math.abs(e[f]-d[f]),v=Math.abs(e[f]-c[f]),w=[],b=[],W={preCount:0,nextCount:0};if(i){const t=Math.abs(e[f]-a[f]);if(v>=h&&t<h)return;const s=v<h?c:e;l.index+=2,l.pre=null,w.push({x:x?i.x:a.x,y:x?a.y:i.y},{x:x?i.x:s.x,y:x?s.y:i.y})}else if(m<h&&m<=v){const t=1===o?1:2;W.preCount=t,l.index-=t,1!==o&&(l.pre={x:x?a.x:e.x,y:x?e.y:a.y})}else if(v<h){if(t[o+3]){if(Math.abs(t[o+3][y]-a[y])<h)return}b.push({index:o,x:x?a.x:c.x,y:x?c.y:a.y})}else b.push({index:o,x:x?a.x:e.x,y:x?e.y:a.y});if(n){const t=Math.abs(e[f]-p[f]);if(m>=h&&t<h)return;const s=m<h?d:e;l.next=null,w.push({x:x?n.x:s.x,y:x?s.y:n.y},{x:x?n.x:p.x,y:x?p.y:n.y})}else if(v<h&&v<=m){const t=o===r-3?1:2;W.nextCount=t,o!==r-3&&(l.next={x:x?p.x:e.x,y:x?e.y:p.y})}else if(m<h){if(t[o-2]){if(Math.abs(t[o-2][y]-p[y])<h)return}b.push({index:o+1,x:x?p.x:d.x,y:x?d.y:p.y})}else b.push({index:o+1,x:x?p.x:e.x,y:x?e.y:p.y});if(s.pre=l.pre,s.next=l.next,s.index=l.index,b.length&&(P(this.selectItem,b),P(this.line,b)),w.length&&(u(this.selectItem,w,o+1),u(this.line,w,o+1)),W.preCount||W.nextCount){const{preCount:e,nextCount:t}=W,s=e+t;let i=e?o-1||1:o+1;i>=o+1&&(i+=w.length),g(this.selectItem,i,s),g(this.line,i,s)}}redrawEllipses(){const{points:e}=this.selectItem,t=x(e);this.drawEdgeEllipses(e),this.drawMidEllipses(t)}removeEllipses(){this.edgeEllipses.forEach((e=>{e.remove()})),this.midEllipses.forEach((e=>{e.remove()})),this.edgeEllipses=[],this.midEllipses=[]}}return i([s.sortType(l)],w.prototype,"zIndex",void 0),e.FreePolylineEditor=v,e.OrthoPolylineEditor=w,e}({},LeaferIN.arrow,LeaferUI);
