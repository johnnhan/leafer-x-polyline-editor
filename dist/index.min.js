this.LeaferX=this.LeaferX||{},this.LeaferX.PolylineEditor=function(t,e,i){"use strict";function s(t,e,i,s){var n,o=arguments.length,r=o<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,s);else for(var l=t.length-1;l>=0;l--)(n=t[l])&&(r=(o<3?n(r):o>3?n(e,i,r):n(e,i))||r);return o>3&&r&&Object.defineProperty(e,i,r),r}"function"==typeof SuppressedError&&SuppressedError;let n=class extends e.ArrowData{};function o(t){return t.length>=2}function r(t){return!(t.length<2)&&t.every((t,e,i)=>0===e||(l(i[e-1],t)?!i[e-2]||h(i[e-2],i[e-1]):!!h(i[e-1],t)&&(!i[e-2]||l(i[e-2],i[e-1]))))}function l(t,e){return t.y===e.y&&t.x!==e.x}function h(t,e){return t.x===e.x&&t.y!==e.y}function a(t,e,i){const s=[...t.points];s.splice(i,0,...e),t.setAttr("points",s)}function y(t,e,i){const s=[...t.points];s.splice(e,i),t.setAttr("points",s)}function d(t,e){const i=[...t.points];e.forEach(t=>{const{index:e,x:s,y:n}=t;i[e]={x:s,y:n}}),t.setAttr("points",i)}function x(t,e){const i=e.map(e=>t.getInnerPoint(e));t.setAttr("points",i)}const p="round",c="round",u="none",f="none",g=10,E={moveable:!0};t.FreePolyline=class extends e.Arrow{get __tag(){return"FreePolyline"}constructor(t){if(super(t),!o(this.points)){const e=JSON.stringify(t);throw new Error(`Params points can't paint an orthogonal polylines!\n${e}`)}}},s([i.dataProcessor(n)],t.FreePolyline.prototype,"__",void 0),s([i.boundsType(p)],t.FreePolyline.prototype,"strokeCap",void 0),s([i.boundsType(c)],t.FreePolyline.prototype,"strokeJoin",void 0),s([i.boundsType(u)],t.FreePolyline.prototype,"startArrow",void 0),s([i.boundsType(f)],t.FreePolyline.prototype,"endArrow",void 0),s([i.createAttr(E)],t.FreePolyline.prototype,"editConfig",void 0),t.FreePolyline=s([i.registerUI()],t.FreePolyline);class m extends e.ArrowData{set editConfig(t){this._editConfig=Object.assign(Object.assign({},E),t)}}t.OrthoPolyline=class extends e.Arrow{get __tag(){return"OrthoPolyline"}constructor(t){if(super(t),!r(this.points)){const e=JSON.stringify(t);throw new Error(`Params points can't paint an orthogonal polylines!\n${e}`)}}setStart(t){const{points:e}=this,i=[...e],s=i[0],n=i[1],o=l(s,n);if(2===i.length){const t=o?(s.x+n.x)/2:(s.y+n.y)/2;i.splice(1,0,{x:o?t:s.x,y:o?s.y:t},{x:o?t:n.x,y:o?n.y:t})}else{const e=i[2];s.x=t.x===e.x?t.x+1e-6:t.x,s.y=t.y===e.y?t.y+1e-6:t.y,i[1]={x:o?n.x:s.x,y:o?s.y:n.y}}this.setAttr("points",i)}setEnd(t){const{points:e}=this,i=[...e],s=i.at(-1),n=i.at(-2),o=l(s,n);if(2===i.length){const t=o?(s.x+n.x)/2:(s.y+n.y)/2;i.splice(-1,0,{x:o?t:n.x,y:o?n.y:t},{x:o?t:s.x,y:o?s.y:t})}else{const e=i.at(-3);s.x=t.x===e.x?t.x+1e-6:t.x,s.y=t.y===e.y?t.y+1e-6:t.y,i[i.length-2]={x:o?n.x:s.x,y:o?s.y:n.y}}this.setAttr("points",i)}},s([i.dataProcessor(m)],t.OrthoPolyline.prototype,"__",void 0),s([i.strokeType(p)],t.OrthoPolyline.prototype,"strokeCap",void 0),s([i.strokeType(c)],t.OrthoPolyline.prototype,"strokeJoin",void 0),s([e.arrowType(u)],t.OrthoPolyline.prototype,"startArrow",void 0),s([e.arrowType(f)],t.OrthoPolyline.prototype,"endArrow",void 0),s([i.dataType(E)],t.OrthoPolyline.prototype,"editConfig",void 0),t.OrthoPolyline=s([i.registerUI()],t.OrthoPolyline);class b extends i.GroupData{}function v(t,e){const i=t[e],s=t[e+1];return l(i,s)?Math.abs(i.x-s.x)>=20:Math.abs(i.y-s.y)>=20}function P(t,e,i,s){const{points:n}=i;2===n.length?function(t,e,i,s,n){const{index:o,side:r,spaced:h,length:y}=i,p=0===o,c=l(e[0],e[1]),u=p?e[1]:e[0],f=c?"x":"y",E=c?"y":"x",m=p?0:e.length-1,b=Math.abs(t[E]-u[E]),v=Math.abs(t[f]-u[f]),P=[],w=[];if(v<g)return;if(b<g)w.push({index:m,x:c?t.x:u.x,y:c?u.y:t.y});else if(w.push({index:m,x:t.x,y:t.y}),r)i.side=null,P.push({x:c?t.x:r.x,y:c?r.y:t.y});else{const s=h?h[f]:(e[0][f]+e[1][f])/2;if(Math.abs(s-t[f])<g)return;const n={x:c?s:t.x,y:c?t.y:s},o={x:c?s:u.x,y:c?u.y:s};i.spaced=null,p?3===y?P.push(n):P.push(n,o):3===y?P.push(n):P.push(o,n)}w.length&&(d(s,w),x(n,s.points));P.length&&(a(s,P,1),x(n,s.points))}(t,n,e,i,s):function(t,e,i,s,n){const{index:o,side:r,spaced:h}=i,p=0===o,c=e.length,u=p?e[0]:e.at(-1),f=p?e[1]:e.at(-2),E=p?e[2]:e.at(-3),m=p?e[3]:e.at(-4),b=l(u,f),v=p?0:c-1,P=p?1:c-2,w=b?"x":"y",A=b?"y":"x",D=Math.abs(t[A]-f[A]),I=Math.abs(t[w]-f[w]),O=Math.abs(t[A]-E[A]),M=Math.abs(t[w]-E[w]),k=[],F=[];let C=null;if(O<g&&M<g)return;if(m){const e=Math.abs(t[A]-m[A]),i=Math.abs(t[w]-m[w]);if(e<g&&i<g)return}if(r||h){if(I<g)return;if(D<g)F.push({index:v,x:b?t.x:f.x,y:b?f.y:t.y});else if(F.push({index:v,x:t.x,y:t.y}),r)i.side=null,k.push({x:b?t.x:r.x,y:b?r.y:t.y});else{if(Math.abs(h[w]-t[w])<g)return;const e={x:b?h.x:t.x,y:b?t.y:h.y},s={x:b?h.x:f.x,y:b?f.y:h.y};i.spaced=null,p?k.push(e,s):k.push(s,e)}}else if(I<g)F.push({index:v,x:b?f.x:t.x,y:b?t.y:f.y}),i.side={x:b?f.x:t.x,y:b?t.y:f.y},C={index:P,count:1};else if(O<g){const e=p?1:c-3||1,s=3===c?1:2;F.push({index:v,x:b?t.x:E.x,y:b?E.y:t.y}),i.length=c,i.spaced={x:b?f.x:E.x,y:b?E.y:f.y},C={index:e,count:s}}else F.push({index:v,x:t.x,y:t.y},{index:P,x:b?f.x:t.x,y:b?t.y:f.y});F.length&&(d(s,F),x(n,s.points));if(k.length){a(s,k,p?1:c-1),x(n,s.points)}if(C){const{index:t,count:e}=C;y(n,t,e),y(s,t,e)}}(t,n,e,i,s)}function w(t,e,i,s){const{points:n}=i,o=n.length,{index:r}=e;0===r||r===o-2?function(t,e,i,s,n){const{pre:o,next:r,index:h}=i,y=Object.assign({},i),p=e.length,c=2===p||0===h?e[0]:e[p-2],u=2===p||0===h?e[1]:e[p-1],f=l(c,u),E=f?"y":"x",m=Math.abs(t[E]-c[E]),b=Math.abs(t[E]-u[E]),v=[],P=[];if(m<g||b<g)return;o?(y.index+=2,y.pre=null,v.push({x:f?o.x:c.x,y:f?c.y:o.y},{x:f?o.x:t.x,y:f?t.y:o.y})):0===h?(y.index+=1,v.push({x:f?c.x:t.x,y:f?t.y:c.y})):P.push({index:p-2,x:f?c.x:t.x,y:f?t.y:c.y});r?(y.next=null,v.push({x:f?r.x:t.x,y:f?t.y:r.y},{x:f?r.x:u.x,y:f?u.y:r.y})):h===p-2?v.push({x:f?u.x:t.x,y:f?t.y:u.y}):P.push({index:1,x:f?u.x:t.x,y:f?t.y:u.y});i.pre=y.pre,i.next=y.next,i.index=y.index,P.length&&(d(s,P),x(n,s.points));if(v.length){a(s,v,0===h?1:p-1),x(n,s.points)}}(t,n,e,i,s):function(t,e,i,s,n){const{pre:o,next:r,index:h}=i,p=Object.assign({},i),c=e.length,u=e[h-1],f=e[h],E=e[h+1],m=e[h+2],b=l(f,E),v=b?"x":"y",P=b?"y":"x",w=Math.abs(t[P]-u[P]),A=Math.abs(t[P]-m[P]),D=[],I=[],O={preCount:0,nextCount:0};if(o){const e=Math.abs(t[P]-f[P]);if(A>=g&&e<g)return;const i=A<g?m:t;p.index+=2,p.pre=null,D.push({x:b?o.x:f.x,y:b?f.y:o.y},{x:b?o.x:i.x,y:b?i.y:o.y})}else if(w<g&&w<=A){const e=1===h?1:2;O.preCount=e,p.index-=e,1!==h&&(p.pre={x:b?f.x:t.x,y:b?t.y:f.y})}else if(A<g){if(e[h+3]){if(Math.abs(e[h+3][v]-f[v])<g)return}I.push({index:h,x:b?f.x:m.x,y:b?m.y:f.y})}else I.push({index:h,x:b?f.x:t.x,y:b?t.y:f.y});if(r){const e=Math.abs(t[P]-E[P]);if(w>=g&&e<g)return;const i=w<g?u:t;p.next=null,D.push({x:b?r.x:i.x,y:b?i.y:r.y},{x:b?r.x:E.x,y:b?E.y:r.y})}else if(A<g&&A<=w){const e=h===c-3?1:2;O.nextCount=e,h!==c-3&&(p.next={x:b?E.x:t.x,y:b?t.y:E.y})}else if(w<g){if(e[h-2]){if(Math.abs(e[h-2][v]-E[v])<g)return}I.push({index:h+1,x:b?E.x:u.x,y:b?u.y:E.y})}else I.push({index:h+1,x:b?E.x:t.x,y:b?t.y:E.y});i.pre=p.pre,i.next=p.next,i.index=p.index,I.length&&(d(s,I),x(n,s.points));D.length&&(a(s,D,h+1),x(n,s.points));if(O.preCount||O.nextCount){const{preCount:t,nextCount:e}=O,i=t+e;let o=t?h-1||1:h+1;o>=h+1&&(o+=D.length),y(n,o,i),y(s,o,i)}}(t,n,e,i,s)}function A(t,e){const i=t[e],s=t[e+1];return Math.abs(i.x-s.x)>=20||Math.abs(i.y-s.y)>=20}class D extends i.Group{constructor(t){super(t),this.line=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}get __tag(){return"PolylineEditor"}initEvents(){this.waitLeafer(()=>{const{isApp:t,sky:e}=this.app;if(!t||this.parent!==e)throw new Error("PolylineEditor must be added to the zoomLayer of the App!");this.app.on(i.PointerEvent.DOWN,this.downHandler.bind(this)),this.app.on(i.PointerEvent.DOUBLE_TAP,this.doubleTapHandler.bind(this)),this.app.on(i.ZoomEvent.ZOOM,this.redrawEditor.bind(this)),this.app.on(i.MoveEvent.MOVE,this.redrawEditor.bind(this))})}downHandler(t){if("normal"!==this.app.mode)return;if(![1,2].includes(t.buttons))return;const e=t.target;e.parent!==this&&this.select(e)}doubleTapHandler(t){if("normal"!==this.app.mode)return;if(!this.selectItem)return;t.target.parent!==this&&this.emit("double-tap",{target:this.selectItem})}drawEditor(){const{points:t,editConfig:e}=this.selectItem,{moveable:i}=e,s=t.map(t=>this.selectItem.getWorldPoint(t));if(this.drawLine(s),i){const t=function(t){return t.reduce((t,e,i,s)=>(i>0&&t.push({x:(s[i-1].x+e.x)/2,y:(s[i-1].y+e.y)/2}),t),[])}(s);this.drawEdgeEllipses(s),this.drawMidEllipses(t)}}clearEditor(){this.edgeEllipses.forEach(t=>{t.off(i.DragEvent.DRAG),t.off(i.DragEvent.END),t.destroy()}),this.midEllipses.forEach(t=>{t.off(i.DragEvent.DRAG),t.off(i.DragEvent.END),t.destroy()}),this.line&&(this.line.destroy(),this.line=null),this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawLine(t){const{color:e,strokeWidth:s}=this;this.line=new i.Line({points:t,hittable:!1,name:"editor-line",stroke:e,strokeWidth:s,strokeCap:p,strokeJoin:c}),this.add(this.line)}drawEdgeEllipses(t){const{tag:e}=this.selectItem,s="FreePolyline"===e?t:[t[0],t.at(-1)],{color:n,ellipseWidth:o,strokeWidth:r}=this;s.forEach((t,e)=>{const s=new i.Ellipse({width:o,height:o,x:t.x,y:t.y,draggable:!0,name:"polyline-editor-point-"+(0===e?"start":"end"),around:"center",stroke:n,strokeWidth:r,strokeAlign:"center",fill:"#fff"});this.edgeEllipses.push(s),this.addEdgeEvents(s,e)}),this.add(this.edgeEllipses)}drawMidEllipses(t){const{tag:e}=this.selectItem,s=this.line.points,{color:n,ellipseWidth:o,strokeWidth:r}=this;t.forEach((t,l)=>{const h=new i.Ellipse({width:o,height:o,x:t.x,y:t.y,draggable:!0,name:"polyline-editor-point",around:"center",stroke:"#fff",strokeWidth:r-1,strokeAlign:"center",fill:n,visible:"OrthoPolyline"===e?v(s,l):A(s,l)});this.midEllipses.push(h),this.addMidEvents(h,l)}),this.add(this.midEllipses)}addEdgeEvents(t,e){const{tag:s}=this.selectItem,n={length:this.line.points.length,index:e,side:null,spaced:null};t.on(i.DragEvent.START,()=>{this.hideEllipses(),this.emit("drag-start",{target:this.selectItem,current:t})}),t.on(i.DragEvent.DRAG,()=>{const{x:e,y:i}=t,o={x:e,y:i};"OrthoPolyline"===s?P(o,n,this.line,this.selectItem):"FreePolyline"===s&&function(t,e,i,s){const{index:n}=e;d(i,[{index:n,x:t.x,y:t.y}]),x(s,i.points)}(o,n,this.line,this.selectItem),this.emit("drag",{target:this.selectItem,current:t})}),t.on(i.DragEvent.END,()=>{t.off(i.DragEvent.DRAG),t.off(i.DragEvent.END),this.redrawEditor(),this.emit("drag-end",{target:this.selectItem,current:t})})}addMidEvents(t,e){const{tag:s}=this.selectItem,n={length:this.line.points.length,index:e,pre:null,next:null};t.on(i.DragEvent.START,()=>{this.hideEllipses(),this.emit("drag-start",{target:this.selectItem,current:t})}),t.on(i.DragEvent.DRAG,()=>{const{x:e,y:i}=t,o={x:e,y:i};"OrthoPolyline"===s?w(o,n,this.line,this.selectItem):"FreePolyline"===s&&function(t,e,i,s){const{length:n,index:o}=e,r={x:t.x,y:t.y},l=Object.assign(Object.assign({},r),{index:o+1});n===i.points.length?(a(i,[r],o+1),x(s,i.points)):(d(i,[l]),x(s,i.points))}(o,n,this.line,this.selectItem),this.emit("drag",{target:this.selectItem,current:t})}),t.on(i.DragEvent.END,()=>{t.off(i.DragEvent.DRAG),t.off(i.DragEvent.END),this.redrawEditor(),this.emit("drag-end",{target:this.selectItem,current:t})})}redrawEditor(){this.selectItem&&(this.clearEditor(),this.drawEditor())}hideEllipses(){this.edgeEllipses.forEach(t=>{t.setAttr("visible",!1)}),this.midEllipses.forEach(t=>{t.setAttr("visible",!1)})}select(t){if(t===this.selectItem)return;const e=this.selectItem;this.selectItem&&(this.clearEditor(),this.selectItem=null),["OrthoPolyline","FreePolyline"].includes(t.tag)&&(this.selectItem=t,this.drawEditor()),this.emit("select",{oldValue:e,value:this.selectItem})}cancel(){this.clearEditor(),this.emit("select",{oldValue:this.selectItem,value:null})}}return s([i.dataProcessor(b)],D.prototype,"__",void 0),s([i.createAttr("#1890FF")],D.prototype,"color",void 0),s([i.createAttr(2)],D.prototype,"strokeWidth",void 0),s([i.createAttr(10)],D.prototype,"ellipseWidth",void 0),t.PolylineEditor=D,t.isFreeLine=o,t.isHorizon=l,t.isOrthoLine=r,t.isVertical=h,t}({},LeaferIN.arrow,LeaferUI);
