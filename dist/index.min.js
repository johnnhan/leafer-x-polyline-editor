this.LeaferX=this.LeaferX||{},this.LeaferX.PolylineEditor=function(t,e,i){"use strict";function s(t,e,i,s){var n,o=arguments.length,r=o<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,s);else for(var l=t.length-1;l>=0;l--)(n=t[l])&&(r=(o<3?n(r):o>3?n(e,i,r):n(e,i))||r);return o>3&&r&&Object.defineProperty(e,i,r),r}"function"==typeof SuppressedError&&SuppressedError;let n=class extends e.ArrowData{};function o(t){return!(t.length<2)&&t.every(((t,e,i)=>0===e||(r(i[e-1],t)?!i[e-2]||l(i[e-2],i[e-1]):!!l(i[e-1],t)&&(!i[e-2]||r(i[e-2],i[e-1])))))}function r(t,e){return t.y===e.y&&t.x!==e.x}function l(t,e){return t.x===e.x&&t.y!==e.y}function h(t,e,i){const s=[...t.points];s.splice(i,0,...e),t.setAttr("points",s)}function a(t,e,i){const s=[...t.points];s.splice(e,i),t.setAttr("points",s)}function y(t,e){const i=[...t.points];e.forEach((t=>{const{index:e,x:s,y:n}=t;i[e]={x:s,y:n}})),t.setAttr("points",i)}function d(t,e){const i=e.map((e=>t.getInnerPoint(e)));t.setAttr("points",i)}const x="round",p="round",c="none",u="none",f=10,g={moveable:!0};t.FreePolyline=class extends e.Arrow{get __tag(){return"FreePolyline"}constructor(t){if(super(t),!(this.points.length>=2)){const e=JSON.stringify(t);throw new Error(`Params points can't paint an orthogonal polylines!\n${e}`)}}},s([i.dataProcessor(n)],t.FreePolyline.prototype,"__",void 0),s([i.boundsType(x)],t.FreePolyline.prototype,"strokeCap",void 0),s([i.boundsType(p)],t.FreePolyline.prototype,"strokeJoin",void 0),s([i.boundsType(c)],t.FreePolyline.prototype,"startArrow",void 0),s([i.boundsType(u)],t.FreePolyline.prototype,"endArrow",void 0),s([i.createAttr(g)],t.FreePolyline.prototype,"editConfig",void 0),t.FreePolyline=s([i.registerUI()],t.FreePolyline);class E extends e.ArrowData{set editConfig(t){this._editConfig=Object.assign(Object.assign({},g),t)}}t.OrthoPolyline=class extends e.Arrow{get __tag(){return"OrthoPolyline"}constructor(t){if(super(t),!o(this.points)){const e=JSON.stringify(t);throw new Error(`Params points can't paint an orthogonal polylines!\n${e}`)}}setStart(t){const{points:e}=this,i=[...e],s=i[0],n=i[1],o=r(s,n);if(2===i.length){const t=o?(s.x+n.x)/2:(s.y+n.y)/2;i.splice(1,0,{x:o?t:s.x,y:o?s.y:t},{x:o?t:n.x,y:o?n.y:t})}else{const e=i[2];s.x=t.x===e.x?t.x+1e-6:t.x,s.y=t.y===e.y?t.y+1e-6:t.y,i[1]={x:o?n.x:s.x,y:o?s.y:n.y}}this.setAttr("points",i)}setEnd(t){const{points:e}=this,i=[...e],s=i.at(-1),n=i.at(-2),o=r(s,n);if(2===i.length){const t=o?(s.x+n.x)/2:(s.y+n.y)/2;i.splice(-1,0,{x:o?t:n.x,y:o?n.y:t},{x:o?t:s.x,y:o?s.y:t})}else{const e=i.at(-3);s.x=t.x===e.x?t.x+1e-6:t.x,s.y=t.y===e.y?t.y+1e-6:t.y,i[i.length-2]={x:o?n.x:s.x,y:o?s.y:n.y}}this.setAttr("points",i)}},s([i.dataProcessor(E)],t.OrthoPolyline.prototype,"__",void 0),s([i.strokeType(x)],t.OrthoPolyline.prototype,"strokeCap",void 0),s([i.strokeType(p)],t.OrthoPolyline.prototype,"strokeJoin",void 0),s([e.arrowType(c)],t.OrthoPolyline.prototype,"startArrow",void 0),s([e.arrowType(u)],t.OrthoPolyline.prototype,"endArrow",void 0),s([i.dataType(g)],t.OrthoPolyline.prototype,"editConfig",void 0),t.OrthoPolyline=s([i.registerUI()],t.OrthoPolyline);class m extends i.GroupData{}function b(t,e){const i=t[e],s=t[e+1];return r(i,s)?Math.abs(i.x-s.x)>=20:Math.abs(i.y-s.y)>=20}function v(t,e,i,s){const{points:n}=i;2===n.length?function(t,e,i,s,n){const{index:o,side:l,spaced:a,length:x}=i,p=0===o,c=r(e[0],e[1]),u=p?e[1]:e[0],g=c?"x":"y",E=c?"y":"x",m=p?0:e.length-1,b=Math.abs(t[E]-u[E]),v=Math.abs(t[g]-u[g]),P=[],w=[];if(v<f)return;if(b<f)w.push({index:m,x:c?t.x:u.x,y:c?u.y:t.y});else if(w.push({index:m,x:t.x,y:t.y}),l)i.side=null,P.push({x:c?t.x:l.x,y:c?l.y:t.y});else{const s=a?a[g]:(e[0][g]+e[1][g])/2;if(Math.abs(s-t[g])<f)return;const n={x:c?s:t.x,y:c?t.y:s},o={x:c?s:u.x,y:c?u.y:s};i.spaced=null,p?3===x?P.push(n):P.push(n,o):3===x?P.push(n):P.push(o,n)}w.length&&(y(s,w),d(n,s.points));P.length&&(h(s,P,1),d(n,s.points))}(t,n,e,i,s):function(t,e,i,s,n){const{index:o,side:l,spaced:x}=i,p=0===o,c=e.length,u=p?e[0]:e.at(-1),g=p?e[1]:e.at(-2),E=p?e[2]:e.at(-3),m=p?e[3]:e.at(-4),b=r(u,g),v=p?0:c-1,P=p?1:c-2,w=b?"x":"y",A=b?"y":"x",D=Math.abs(t[A]-g[A]),I=Math.abs(t[w]-g[w]),O=Math.abs(t[A]-E[A]),M=Math.abs(t[w]-E[w]),k=[],C=[];let F=null;if(O<f&&M<f)return;if(m){const e=Math.abs(t[A]-m[A]),i=Math.abs(t[w]-m[w]);if(e<f&&i<f)return}if(l||x){if(I<f)return;if(D<f)C.push({index:v,x:b?t.x:g.x,y:b?g.y:t.y});else if(C.push({index:v,x:t.x,y:t.y}),l)i.side=null,k.push({x:b?t.x:l.x,y:b?l.y:t.y});else{if(Math.abs(x[w]-t[w])<f)return;const e={x:b?x.x:t.x,y:b?t.y:x.y},s={x:b?x.x:g.x,y:b?g.y:x.y};i.spaced=null,p?k.push(e,s):k.push(s,e)}}else if(I<f)C.push({index:v,x:b?g.x:t.x,y:b?t.y:g.y}),i.side={x:b?g.x:t.x,y:b?t.y:g.y},F={index:P,count:1};else if(O<f){const e=p?1:c-3||1,s=3===c?1:2;C.push({index:v,x:b?t.x:E.x,y:b?E.y:t.y}),i.length=c,i.spaced={x:b?g.x:E.x,y:b?E.y:g.y},F={index:e,count:s}}else C.push({index:v,x:t.x,y:t.y},{index:P,x:b?g.x:t.x,y:b?t.y:g.y});C.length&&(y(s,C),d(n,s.points));if(k.length){h(s,k,p?1:c-1),d(n,s.points)}if(F){const{index:t,count:e}=F;a(n,t,e),a(s,t,e)}}(t,n,e,i,s)}function P(t,e,i,s){const{points:n}=i,o=n.length,{index:l}=e;0===l||l===o-2?function(t,e,i,s,n){const{pre:o,next:l,index:a}=i,x=Object.assign({},i),p=e.length,c=2===p||0===a?e[0]:e[p-2],u=2===p||0===a?e[1]:e[p-1],g=r(c,u),E=g?"y":"x",m=Math.abs(t[E]-c[E]),b=Math.abs(t[E]-u[E]),v=[],P=[];if(m<f||b<f)return;o?(x.index+=2,x.pre=null,v.push({x:g?o.x:c.x,y:g?c.y:o.y},{x:g?o.x:t.x,y:g?t.y:o.y})):0===a?(x.index+=1,v.push({x:g?c.x:t.x,y:g?t.y:c.y})):P.push({index:p-2,x:g?c.x:t.x,y:g?t.y:c.y});l?(x.next=null,v.push({x:g?l.x:t.x,y:g?t.y:l.y},{x:g?l.x:u.x,y:g?u.y:l.y})):a===p-2?v.push({x:g?u.x:t.x,y:g?t.y:u.y}):P.push({index:1,x:g?u.x:t.x,y:g?t.y:u.y});i.pre=x.pre,i.next=x.next,i.index=x.index,P.length&&(y(s,P),d(n,s.points));if(v.length){h(s,v,0===a?1:p-1),d(n,s.points)}}(t,n,e,i,s):function(t,e,i,s,n){const{pre:o,next:l,index:x}=i,p=Object.assign({},i),c=e.length,u=e[x-1],g=e[x],E=e[x+1],m=e[x+2],b=r(g,E),v=b?"x":"y",P=b?"y":"x",w=Math.abs(t[P]-u[P]),A=Math.abs(t[P]-m[P]),D=[],I=[],O={preCount:0,nextCount:0};if(o){const e=Math.abs(t[P]-g[P]);if(A>=f&&e<f)return;const i=A<f?m:t;p.index+=2,p.pre=null,D.push({x:b?o.x:g.x,y:b?g.y:o.y},{x:b?o.x:i.x,y:b?i.y:o.y})}else if(w<f&&w<=A){const e=1===x?1:2;O.preCount=e,p.index-=e,1!==x&&(p.pre={x:b?g.x:t.x,y:b?t.y:g.y})}else if(A<f){if(e[x+3]){if(Math.abs(e[x+3][v]-g[v])<f)return}I.push({index:x,x:b?g.x:m.x,y:b?m.y:g.y})}else I.push({index:x,x:b?g.x:t.x,y:b?t.y:g.y});if(l){const e=Math.abs(t[P]-E[P]);if(w>=f&&e<f)return;const i=w<f?u:t;p.next=null,D.push({x:b?l.x:i.x,y:b?i.y:l.y},{x:b?l.x:E.x,y:b?E.y:l.y})}else if(A<f&&A<=w){const e=x===c-3?1:2;O.nextCount=e,x!==c-3&&(p.next={x:b?E.x:t.x,y:b?t.y:E.y})}else if(w<f){if(e[x-2]){if(Math.abs(e[x-2][v]-E[v])<f)return}I.push({index:x+1,x:b?E.x:u.x,y:b?u.y:E.y})}else I.push({index:x+1,x:b?E.x:t.x,y:b?t.y:E.y});i.pre=p.pre,i.next=p.next,i.index=p.index,I.length&&(y(s,I),d(n,s.points));D.length&&(h(s,D,x+1),d(n,s.points));if(O.preCount||O.nextCount){const{preCount:t,nextCount:e}=O,i=t+e;let o=t?x-1||1:x+1;o>=x+1&&(o+=D.length),a(n,o,i),a(s,o,i)}}(t,n,e,i,s)}function w(t,e){const i=t[e],s=t[e+1];return Math.abs(i.x-s.x)>=20||Math.abs(i.y-s.y)>=20}class A extends i.Group{constructor(t){super(t),this.line=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}get __tag(){return"PolylineEditor"}initEvents(){this.waitLeafer((()=>{const{isApp:t,sky:e}=this.app;if(!t||this.parent!==e)throw new Error("PolylineEditor must be added to the zoomLayer of the App!");this.app.on(i.PointerEvent.DOWN,this.downHandler.bind(this)),this.app.on(i.PointerEvent.DOUBLE_TAP,this.doubleTapHandler.bind(this)),this.app.on(i.ZoomEvent.ZOOM,this.redrawEditor.bind(this)),this.app.on(i.MoveEvent.MOVE,this.redrawEditor.bind(this))}))}downHandler(t){if("normal"!==this.app.mode)return;if(![1,2].includes(t.buttons))return;const e=t.target;e.parent!==this&&this.select(e)}doubleTapHandler(t){if("normal"!==this.app.mode)return;if(!this.selectItem)return;t.target.parent!==this&&this.emit("double-tap",{target:this.selectItem})}drawEditor(){const{points:t,editConfig:e}=this.selectItem,{moveable:i}=e,s=t.map((t=>this.selectItem.getWorldPoint(t)));if(this.drawLine(s),i){const t=function(t){return t.reduce(((t,e,i,s)=>(i>0&&t.push({x:(s[i-1].x+e.x)/2,y:(s[i-1].y+e.y)/2}),t)),[])}(s);this.drawEdgeEllipses(s),this.drawMidEllipses(t)}}clearEditor(){this.edgeEllipses.forEach((t=>{t.off(i.DragEvent.DRAG),t.off(i.DragEvent.END),t.destroy()})),this.midEllipses.forEach((t=>{t.off(i.DragEvent.DRAG),t.off(i.DragEvent.END),t.destroy()})),this.line&&(this.line.destroy(),this.line=null),this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawLine(t){const{color:e,strokeWidth:s}=this;this.line=new i.Line({points:t,hittable:!1,name:"editor-line",stroke:e,strokeWidth:s,strokeCap:x,strokeJoin:p}),this.add(this.line)}drawEdgeEllipses(t){const{tag:e}=this.selectItem,s="FreePolyline"===e?t:[t[0],t.at(-1)],{color:n,ellipseWidth:o,strokeWidth:r}=this;s.forEach(((t,e)=>{const s=new i.Ellipse({width:o,height:o,x:t.x,y:t.y,draggable:!0,name:"polyline-editor-point-"+(0===e?"start":"end"),around:"center",stroke:n,strokeWidth:r,strokeAlign:"center",fill:"#fff"});this.edgeEllipses.push(s),this.addEdgeEvents(s,e)})),this.add(this.edgeEllipses)}drawMidEllipses(t){const{tag:e}=this.selectItem,s=this.line.points,{color:n,ellipseWidth:o,strokeWidth:r}=this;t.forEach(((t,l)=>{const h=new i.Ellipse({width:o,height:o,x:t.x,y:t.y,draggable:!0,name:"polyline-editor-point",around:"center",stroke:"#fff",strokeWidth:r-1,strokeAlign:"center",fill:n,visible:"OrthoPolyline"===e?b(s,l):w(s,l)});this.midEllipses.push(h),this.addMidEvents(h,l)})),this.add(this.midEllipses)}addEdgeEvents(t,e){const{tag:s}=this.selectItem,n={length:this.line.points.length,index:e,side:null,spaced:null};t.on(i.DragEvent.START,(e=>{this.hideEllipses(),this.emit("drag-start",{target:this.selectItem,current:t})})),t.on(i.DragEvent.DRAG,(e=>{const{x:i,y:o}=t,r={x:i,y:o};"OrthoPolyline"===s?v(r,n,this.line,this.selectItem):"FreePolyline"===s&&function(t,e,i,s){const{index:n}=e;y(i,[{index:n,x:t.x,y:t.y}]),d(s,i.points)}(r,n,this.line,this.selectItem),this.emit("drag",{target:this.selectItem,current:t})})),t.on(i.DragEvent.END,(e=>{t.off(i.DragEvent.DRAG),t.off(i.DragEvent.END),this.redrawEditor(),this.emit("drag-end",{target:this.selectItem,current:t})}))}addMidEvents(t,e){const{tag:s}=this.selectItem,n={length:this.line.points.length,index:e,pre:null,next:null};t.on(i.DragEvent.START,(e=>{this.hideEllipses(),this.emit("drag-start",{target:this.selectItem,current:t})})),t.on(i.DragEvent.DRAG,(e=>{const{x:i,y:o}=t,r={x:i,y:o};"OrthoPolyline"===s?P(r,n,this.line,this.selectItem):"FreePolyline"===s&&function(t,e,i,s){const{length:n,index:o}=e,r={x:t.x,y:t.y},l=Object.assign(Object.assign({},r),{index:o+1});n===i.points.length?(h(i,[r],o+1),d(s,i.points)):(y(i,[l]),d(s,i.points))}(r,n,this.line,this.selectItem),this.emit("drag",{target:this.selectItem,current:t})})),t.on(i.DragEvent.END,(e=>{t.off(i.DragEvent.DRAG),t.off(i.DragEvent.END),this.redrawEditor(),this.emit("drag-end",{target:this.selectItem,current:t})}))}redrawEditor(){this.selectItem&&(this.clearEditor(),this.drawEditor())}hideEllipses(){this.edgeEllipses.forEach((t=>{t.setAttr("visible",!1)})),this.midEllipses.forEach((t=>{t.setAttr("visible",!1)}))}select(t){if(t===this.selectItem)return;const e=this.selectItem;this.selectItem&&(this.clearEditor(),this.selectItem=null),["OrthoPolyline","FreePolyline"].includes(t.tag)&&(this.selectItem=t,this.drawEditor()),this.emit("line-select",{oldValue:e,value:this.selectItem})}cancel(){this.clearEditor(),this.emit("line-select",{oldValue:this.selectItem,value:null})}}return s([i.dataProcessor(m)],A.prototype,"__",void 0),s([i.createAttr("#1890FF")],A.prototype,"color",void 0),s([i.createAttr(2)],A.prototype,"strokeWidth",void 0),s([i.createAttr(10)],A.prototype,"ellipseWidth",void 0),t.PolylineEditor=A,t.isHorizon=r,t.isOrthoLine=o,t.isVertical=l,t}({},LeaferIN.arrow,LeaferUI);
