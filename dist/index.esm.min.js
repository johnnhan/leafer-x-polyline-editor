import{ArrowData as t,Arrow as e,arrowType as s}from"@leafer-in/arrow";import{dataProcessor as i,boundsType as n,createAttr as o,registerUI as r,strokeType as l,dataType as h,GroupData as x,Group as d,PointerEvent as y,ZoomEvent as a,MoveEvent as p,DragEvent as c,Line as u,Ellipse as f}from"@leafer-ui/core";function g(t,e,s,i){var n,o=arguments.length,r=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,i);else for(var l=t.length-1;l>=0;l--)(n=t[l])&&(r=(o<3?n(r):o>3?n(e,s,r):n(e,s))||r);return o>3&&r&&Object.defineProperty(e,s,r),r}"function"==typeof SuppressedError&&SuppressedError;function E(t){return t.length>=2}function m(t){return!(t.length<2)&&t.every(((t,e,s)=>0===e||(b(s[e-1],t)?!s[e-2]||w(s[e-2],s[e-1]):!!w(s[e-1],t)&&(!s[e-2]||b(s[e-2],s[e-1])))))}function b(t,e){return t.y===e.y&&t.x!==e.x}function w(t,e){return t.x===e.x&&t.y!==e.y}function v(t,e,s){const i=[...t.points];i.splice(s,0,...e),t.setAttr("points",i)}function I(t,e,s){const i=[...t.points];i.splice(e,s),t.setAttr("points",i)}function M(t,e){const s=[...t.points];e.forEach((t=>{const{index:e,x:i,y:n}=t;s[e]={x:i,y:n}})),t.setAttr("points",s)}function A(t,e){const s=e.map((e=>t.getInnerPoint(e)));t.setAttr("points",s)}const O="round",k="round",P="none",C="none",D=10,_={moveable:!0};let W=class extends e{get __tag(){return"FreePolyline"}constructor(t){if(super(t),!E(this.points)){const e=JSON.stringify(t);throw new Error(`Params points can't paint an orthogonal polylines!\n${e}`)}}};g([i(class extends t{})],W.prototype,"__",void 0),g([n(O)],W.prototype,"strokeCap",void 0),g([n(k)],W.prototype,"strokeJoin",void 0),g([n(P)],W.prototype,"startArrow",void 0),g([n(C)],W.prototype,"endArrow",void 0),g([o(_)],W.prototype,"editConfig",void 0),W=g([r()],W);let R=class extends e{get __tag(){return"OrthoPolyline"}constructor(t){if(super(t),!m(this.points)){const e=JSON.stringify(t);throw new Error(`Params points can't paint an orthogonal polylines!\n${e}`)}}setStart(t){const{points:e}=this,s=[...e],i=s[0],n=s[1],o=b(i,n);if(2===s.length){const t=o?(i.x+n.x)/2:(i.y+n.y)/2;s.splice(1,0,{x:o?t:i.x,y:o?i.y:t},{x:o?t:n.x,y:o?n.y:t})}else{const e=s[2];i.x=t.x===e.x?t.x+1e-6:t.x,i.y=t.y===e.y?t.y+1e-6:t.y,s[1]={x:o?n.x:i.x,y:o?i.y:n.y}}this.setAttr("points",s)}setEnd(t){const{points:e}=this,s=[...e],i=s.at(-1),n=s.at(-2),o=b(i,n);if(2===s.length){const t=o?(i.x+n.x)/2:(i.y+n.y)/2;s.splice(-1,0,{x:o?t:n.x,y:o?n.y:t},{x:o?t:i.x,y:o?i.y:t})}else{const e=s.at(-3);i.x=t.x===e.x?t.x+1e-6:t.x,i.y=t.y===e.y?t.y+1e-6:t.y,s[s.length-2]={x:o?n.x:i.x,y:o?i.y:n.y}}this.setAttr("points",s)}};g([i(class extends t{set editConfig(t){this._editConfig=Object.assign(Object.assign({},_),t)}})],R.prototype,"__",void 0),g([l(O)],R.prototype,"strokeCap",void 0),g([l(k)],R.prototype,"strokeJoin",void 0),g([s(P)],R.prototype,"startArrow",void 0),g([s(C)],R.prototype,"endArrow",void 0),g([h(_)],R.prototype,"editConfig",void 0),R=g([r()],R);function j(t,e){const s=t[e],i=t[e+1];return b(s,i)?Math.abs(s.x-i.x)>=20:Math.abs(s.y-i.y)>=20}function N(t,e,s,i){const{points:n}=s;2===n.length?function(t,e,s,i,n){const{index:o,side:r,spaced:l,length:h}=s,x=0===o,d=b(e[0],e[1]),y=x?e[1]:e[0],a=d?"x":"y",p=d?"y":"x",c=x?0:e.length-1,u=Math.abs(t[p]-y[p]),f=Math.abs(t[a]-y[a]),g=[],E=[];if(f<D)return;if(u<D)E.push({index:c,x:d?t.x:y.x,y:d?y.y:t.y});else if(E.push({index:c,x:t.x,y:t.y}),r)s.side=null,g.push({x:d?t.x:r.x,y:d?r.y:t.y});else{const i=l?l[a]:(e[0][a]+e[1][a])/2;if(Math.abs(i-t[a])<D)return;const n={x:d?i:t.x,y:d?t.y:i},o={x:d?i:y.x,y:d?y.y:i};s.spaced=null,x?3===h?g.push(n):g.push(n,o):3===h?g.push(n):g.push(o,n)}E.length&&(M(i,E),A(n,i.points));g.length&&(v(i,g,1),A(n,i.points))}(t,n,e,s,i):function(t,e,s,i,n){const{index:o,side:r,spaced:l}=s,h=0===o,x=e.length,d=h?e[0]:e.at(-1),y=h?e[1]:e.at(-2),a=h?e[2]:e.at(-3),p=h?e[3]:e.at(-4),c=b(d,y),u=h?0:x-1,f=h?1:x-2,g=c?"x":"y",E=c?"y":"x",m=Math.abs(t[E]-y[E]),w=Math.abs(t[g]-y[g]),O=Math.abs(t[E]-a[E]),k=Math.abs(t[g]-a[g]),P=[],C=[];let _=null;if(O<D&&k<D)return;if(p){const e=Math.abs(t[E]-p[E]),s=Math.abs(t[g]-p[g]);if(e<D&&s<D)return}if(r||l){if(w<D)return;if(m<D)C.push({index:u,x:c?t.x:y.x,y:c?y.y:t.y});else if(C.push({index:u,x:t.x,y:t.y}),r)s.side=null,P.push({x:c?t.x:r.x,y:c?r.y:t.y});else{if(Math.abs(l[g]-t[g])<D)return;const e={x:c?l.x:t.x,y:c?t.y:l.y},i={x:c?l.x:y.x,y:c?y.y:l.y};s.spaced=null,h?P.push(e,i):P.push(i,e)}}else if(w<D)C.push({index:u,x:c?y.x:t.x,y:c?t.y:y.y}),s.side={x:c?y.x:t.x,y:c?t.y:y.y},_={index:f,count:1};else if(O<D){const e=h?1:x-3||1,i=3===x?1:2;C.push({index:u,x:c?t.x:a.x,y:c?a.y:t.y}),s.length=x,s.spaced={x:c?y.x:a.x,y:c?a.y:y.y},_={index:e,count:i}}else C.push({index:u,x:t.x,y:t.y},{index:f,x:c?y.x:t.x,y:c?t.y:y.y});C.length&&(M(i,C),A(n,i.points));if(P.length){v(i,P,h?1:x-1),A(n,i.points)}if(_){const{index:t,count:e}=_;I(n,t,e),I(i,t,e)}}(t,n,e,s,i)}function F(t,e,s,i){const{points:n}=s,o=n.length,{index:r}=e;0===r||r===o-2?function(t,e,s,i,n){const{pre:o,next:r,index:l}=s,h=Object.assign({},s),x=e.length,d=2===x||0===l?e[0]:e[x-2],y=2===x||0===l?e[1]:e[x-1],a=b(d,y),p=a?"y":"x",c=Math.abs(t[p]-d[p]),u=Math.abs(t[p]-y[p]),f=[],g=[];if(c<D||u<D)return;o?(h.index+=2,h.pre=null,f.push({x:a?o.x:d.x,y:a?d.y:o.y},{x:a?o.x:t.x,y:a?t.y:o.y})):0===l?(h.index+=1,f.push({x:a?d.x:t.x,y:a?t.y:d.y})):g.push({index:x-2,x:a?d.x:t.x,y:a?t.y:d.y});r?(h.next=null,f.push({x:a?r.x:t.x,y:a?t.y:r.y},{x:a?r.x:y.x,y:a?y.y:r.y})):l===x-2?f.push({x:a?y.x:t.x,y:a?t.y:y.y}):g.push({index:1,x:a?y.x:t.x,y:a?t.y:y.y});s.pre=h.pre,s.next=h.next,s.index=h.index,g.length&&(M(i,g),A(n,i.points));if(f.length){v(i,f,0===l?1:x-1),A(n,i.points)}}(t,n,e,s,i):function(t,e,s,i,n){const{pre:o,next:r,index:l}=s,h=Object.assign({},s),x=e.length,d=e[l-1],y=e[l],a=e[l+1],p=e[l+2],c=b(y,a),u=c?"x":"y",f=c?"y":"x",g=Math.abs(t[f]-d[f]),E=Math.abs(t[f]-p[f]),m=[],w=[],O={preCount:0,nextCount:0};if(o){const e=Math.abs(t[f]-y[f]);if(E>=D&&e<D)return;const s=E<D?p:t;h.index+=2,h.pre=null,m.push({x:c?o.x:y.x,y:c?y.y:o.y},{x:c?o.x:s.x,y:c?s.y:o.y})}else if(g<D&&g<=E){const e=1===l?1:2;O.preCount=e,h.index-=e,1!==l&&(h.pre={x:c?y.x:t.x,y:c?t.y:y.y})}else if(E<D){if(e[l+3]){if(Math.abs(e[l+3][u]-y[u])<D)return}w.push({index:l,x:c?y.x:p.x,y:c?p.y:y.y})}else w.push({index:l,x:c?y.x:t.x,y:c?t.y:y.y});if(r){const e=Math.abs(t[f]-a[f]);if(g>=D&&e<D)return;const s=g<D?d:t;h.next=null,m.push({x:c?r.x:s.x,y:c?s.y:r.y},{x:c?r.x:a.x,y:c?a.y:r.y})}else if(E<D&&E<=g){const e=l===x-3?1:2;O.nextCount=e,l!==x-3&&(h.next={x:c?a.x:t.x,y:c?t.y:a.y})}else if(g<D){if(e[l-2]){if(Math.abs(e[l-2][u]-a[u])<D)return}w.push({index:l+1,x:c?a.x:d.x,y:c?d.y:a.y})}else w.push({index:l+1,x:c?a.x:t.x,y:c?t.y:a.y});s.pre=h.pre,s.next=h.next,s.index=h.index,w.length&&(M(i,w),A(n,i.points));m.length&&(v(i,m,l+1),A(n,i.points));if(O.preCount||O.nextCount){const{preCount:t,nextCount:e}=O,s=t+e;let o=t?l-1||1:l+1;o>=l+1&&(o+=m.length),I(n,o,s),I(i,o,s)}}(t,n,e,s,i)}function S(t,e){const s=t[e],i=t[e+1];return Math.abs(s.x-i.x)>=20||Math.abs(s.y-i.y)>=20}class T extends d{constructor(t){super(t),this.line=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}get __tag(){return"PolylineEditor"}initEvents(){this.waitLeafer((()=>{const{isApp:t,sky:e}=this.app;if(!t||this.parent!==e)throw new Error("PolylineEditor must be added to the zoomLayer of the App!");this.app.on(y.DOWN,this.downHandler.bind(this)),this.app.on(y.DOUBLE_TAP,this.doubleTapHandler.bind(this)),this.app.on(a.ZOOM,this.redrawEditor.bind(this)),this.app.on(p.MOVE,this.redrawEditor.bind(this))}))}downHandler(t){if("normal"!==this.app.mode)return;if(![1,2].includes(t.buttons))return;const e=t.target;e.parent!==this&&this.select(e)}doubleTapHandler(t){if("normal"!==this.app.mode)return;if(!this.selectItem)return;t.target.parent!==this&&this.emit("double-tap",{target:this.selectItem})}drawEditor(){const{points:t,editConfig:e}=this.selectItem,{moveable:s}=e,i=t.map((t=>this.selectItem.getWorldPoint(t)));if(this.drawLine(i),s){const t=function(t){return t.reduce(((t,e,s,i)=>(s>0&&t.push({x:(i[s-1].x+e.x)/2,y:(i[s-1].y+e.y)/2}),t)),[])}(i);this.drawEdgeEllipses(i),this.drawMidEllipses(t)}}clearEditor(){this.edgeEllipses.forEach((t=>{t.off(c.DRAG),t.off(c.END),t.destroy()})),this.midEllipses.forEach((t=>{t.off(c.DRAG),t.off(c.END),t.destroy()})),this.line&&(this.line.destroy(),this.line=null),this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawLine(t){const{color:e,strokeWidth:s}=this;this.line=new u({points:t,hittable:!1,name:"editor-line",stroke:e,strokeWidth:s,strokeCap:O,strokeJoin:k}),this.add(this.line)}drawEdgeEllipses(t){const{tag:e}=this.selectItem,s="FreePolyline"===e?t:[t[0],t.at(-1)],{color:i,ellipseWidth:n,strokeWidth:o}=this;s.forEach(((t,e)=>{const s=new f({width:n,height:n,x:t.x,y:t.y,draggable:!0,name:"polyline-editor-point-"+(0===e?"start":"end"),around:"center",stroke:i,strokeWidth:o,strokeAlign:"center",fill:"#fff"});this.edgeEllipses.push(s),this.addEdgeEvents(s,e)})),this.add(this.edgeEllipses)}drawMidEllipses(t){const{tag:e}=this.selectItem,s=this.line.points,{color:i,ellipseWidth:n,strokeWidth:o}=this;t.forEach(((t,r)=>{const l=new f({width:n,height:n,x:t.x,y:t.y,draggable:!0,name:"polyline-editor-point",around:"center",stroke:"#fff",strokeWidth:o-1,strokeAlign:"center",fill:i,visible:"OrthoPolyline"===e?j(s,r):S(s,r)});this.midEllipses.push(l),this.addMidEvents(l,r)})),this.add(this.midEllipses)}addEdgeEvents(t,e){const{tag:s}=this.selectItem,i={length:this.line.points.length,index:e,side:null,spaced:null};t.on(c.START,(e=>{this.hideEllipses(),this.emit("drag-start",{target:this.selectItem,current:t})})),t.on(c.DRAG,(e=>{const{x:n,y:o}=t,r={x:n,y:o};"OrthoPolyline"===s?N(r,i,this.line,this.selectItem):"FreePolyline"===s&&function(t,e,s,i){const{index:n}=e;M(s,[{index:n,x:t.x,y:t.y}]),A(i,s.points)}(r,i,this.line,this.selectItem),this.emit("drag",{target:this.selectItem,current:t})})),t.on(c.END,(e=>{t.off(c.DRAG),t.off(c.END),this.redrawEditor(),this.emit("drag-end",{target:this.selectItem,current:t})}))}addMidEvents(t,e){const{tag:s}=this.selectItem,i={length:this.line.points.length,index:e,pre:null,next:null};t.on(c.START,(e=>{this.hideEllipses(),this.emit("drag-start",{target:this.selectItem,current:t})})),t.on(c.DRAG,(e=>{const{x:n,y:o}=t,r={x:n,y:o};"OrthoPolyline"===s?F(r,i,this.line,this.selectItem):"FreePolyline"===s&&function(t,e,s,i){const{length:n,index:o}=e,r={x:t.x,y:t.y},l=Object.assign(Object.assign({},r),{index:o+1});n===s.points.length?(v(s,[r],o+1),A(i,s.points)):(M(s,[l]),A(i,s.points))}(r,i,this.line,this.selectItem),this.emit("drag",{target:this.selectItem,current:t})})),t.on(c.END,(e=>{t.off(c.DRAG),t.off(c.END),this.redrawEditor(),this.emit("drag-end",{target:this.selectItem,current:t})}))}redrawEditor(){this.selectItem&&(this.clearEditor(),this.drawEditor())}hideEllipses(){this.edgeEllipses.forEach((t=>{t.setAttr("visible",!1)})),this.midEllipses.forEach((t=>{t.setAttr("visible",!1)}))}select(t){if(t===this.selectItem)return;const e=this.selectItem;this.selectItem&&(this.clearEditor(),this.selectItem=null),["OrthoPolyline","FreePolyline"].includes(t.tag)&&(this.selectItem=t,this.drawEditor()),this.emit("select",{oldValue:e,value:this.selectItem})}cancel(){this.clearEditor(),this.emit("select",{oldValue:this.selectItem,value:null})}}g([i(class extends x{})],T.prototype,"__",void 0),g([o("#1890FF")],T.prototype,"color",void 0),g([o(2)],T.prototype,"strokeWidth",void 0),g([o(10)],T.prototype,"ellipseWidth",void 0);export{W as FreePolyline,R as OrthoPolyline,T as PolylineEditor,E as isFreeLine,b as isHorizon,m as isOrthoLine,w as isVertical};
