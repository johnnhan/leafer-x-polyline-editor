import{ArrowData as t,Arrow as e}from"@leafer-in/arrow";import{boundsType as s,dataProcessor as i,registerUI as h,sortType as n,Group as l,PointerEvent as o,ZoomEvent as r,Rect as d,Line as a,Ellipse as p}from"@leafer-ui/core";function c(t,e,s,i){var h,n=arguments.length,l=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(t,e,s,i);else for(var o=t.length-1;o>=0;o--)(h=t[o])&&(l=(n<3?h(l):n>3?h(e,s,l):h(e,s))||l);return n>3&&l&&Object.defineProperty(e,s,l),l}"function"==typeof SuppressedError&&SuppressedError;const x="#1890FF",y=99999999,f=10,u="round",E="round",g="none",m="none";let w=class extends e{get __tag(){return"FreePolyline"}constructor(t){super(t)}};c([s(u)],w.prototype,"strokeCap",void 0),c([s(E)],w.prototype,"strokeJoin",void 0),c([s(g)],w.prototype,"startArrow",void 0),c([s(m)],w.prototype,"endArrow",void 0),c([i(class extends t{})],w.prototype,"__",void 0),w=c([h()],w);function W(t){return t.reduce(((t,e,s,i)=>(s>0&&t.push({x:(i[s-1].x+e.x)/2,y:(i[s-1].y+e.y)/2}),t)),[])}function P(t){return t.length?function(t){return t.length&&"object"==typeof t[0]}(t)?t:t.reduce(((t,e,s,i)=>(s%2&&t.push({x:i[s-1],y:e}),t)),[]):t}function v(t,e){return t.y===e.y&&t.x!==e.x}function M(t,e){return t.x===e.x&&t.y!==e.y}function b(t,e,s){const i=[...t.points];i.splice(s,0,...e),t.setAttr("points",i)}function I(t,e,s){const i=[...t.points];i.splice(e,s),t.setAttr("points",i)}function O(t,e){const s=[...t.points];e.forEach((t=>{const{index:e,x:i,y:h}=t;s[e]={x:i,y:h}})),t.setAttr("points",s)}function k(t,e){const s=t[e],i=t[e+1];return v(s,i)?Math.abs(s.x-i.x)>=20:Math.abs(s.y-i.y)>=20}let _=class extends e{get __tag(){return"OrthoPolyline"}constructor(t){if(super(t),!this.isOrthoLine(P(this.points)))throw new Error("Params points can't paint an orthogonal polylines!")}isOrthoLine(t){return!(t.length<2)&&t.every(((t,e,s)=>0===e||(v(s[e-1],t)?!s[e-2]||M(s[e-2],s[e-1]):!!M(s[e-1],t)&&(!s[e-2]||v(s[e-2],s[e-1])))))}};c([s(u)],_.prototype,"strokeCap",void 0),c([s(E)],_.prototype,"strokeJoin",void 0),c([s(g)],_.prototype,"startArrow",void 0),c([s(m)],_.prototype,"endArrow",void 0),c([i(class extends t{})],_.prototype,"__",void 0),_=c([h()],_);class D extends l{constructor(t={}){const{color:e,strokeWidth:s,ellipseWidth:i}=t;super(),this.color=null!=e?e:x,this.strokeWidth=null!=s?s:2,this.ellipseWidth=null!=i?i:10,this.line=null,this.rect=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}initEvents(){this.waitLeafer((()=>{const{isApp:t,zoomLayer:e}=this.app;if(!t||!e||e!=this.parent)throw new Error("FreePolylineEditor must be added to the zoomLayer of the App!");this.app.on(o.DOWN,this.downHandler.bind(this)),this.app.on(r.ZOOM,this.zoomHandler.bind(this))}))}downHandler(t){const e=t.target;e!==this.selectItem&&e.parent!==this&&(this.selectItem&&(this.selectItem=null,this.clearEditor()),"FreePolyline"===e.tag&&(this.set({x:e.x,y:e.y}),this.selectItem=e,this.drawEditor()))}zoomHandler(){if(!this.selectItem)return;const{scale:t}=this.leafer,e=this.strokeWidth/t,s=this.ellipseWidth/t;this.line.setAttr("strokeWidth",e),this.edgeEllipses.forEach((t=>{t.set({width:s,height:s,strokeWidth:e})})),this.midEllipses.forEach((t=>{t.set({width:s,height:s,strokeWidth:e})}))}drawEditor(){const{points:t}=this.selectItem,e=P(t),s=W(e);this.drawLine(e),this.drawRect(),this.drawEdgeEllipses(e),this.drawMidEllipses(s)}clearEditor(){this.edgeEllipses.forEach((t=>{t.off(o.DOWN)})),this.midEllipses.forEach((t=>{t.off(o.DOWN)})),this.rect.off(o.DOWN),this.line=null,this.rect=null,this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawRect(){const{x:t,y:e,width:s,height:i}=this.selectItem.boxBounds;this.rect=new d({y:e,x:t,width:s,height:i,fill:"rgba(0, 0, 0, 0)"}),this.add(this.rect),this.addRectEvents(this.rect)}drawLine(t){const{scale:e}=this.leafer,s=this.strokeWidth/e;this.line=new a({points:t,stroke:this.color,strokeWidth:s}),this.add(this.line)}drawEdgeEllipses(t){const{scale:e}=this.leafer,s=this.ellipseWidth/e,i=this.strokeWidth/e;t.forEach(((t,e)=>{const h=new p({width:s,height:s,x:t.x,y:t.y,around:"center",stroke:this.color,strokeWidth:i,fill:"#fff",draggable:!0});this.edgeEllipses.push(h),this.addEdgeEvents(h,e)})),this.add(this.edgeEllipses)}drawMidEllipses(t){const{scale:e}=this.leafer,s=this.ellipseWidth/e,i=this.strokeWidth/e,{points:h}=this.selectItem;t.forEach(((t,e)=>{const n=new p({width:s,height:s,x:t.x,y:t.y,around:"center",stroke:"#fff",strokeWidth:i,fill:this.color,visible:k(h,e)});this.midEllipses.push(n),this.addMidEvents(n,e)})),this.add(this.midEllipses)}addRectEvents(t){t.on(o.DOWN,(e=>{const{x:s,y:i}=this.selectItem,{x:h,y:n}=e.getPagePoint(),l=this.app.on_(o.MOVE,(t=>{const{x:e,y:l}=t.getPagePoint();this.selectItem.set({x:s+e-h,y:i+l-n}),this.set({x:s+e-h,y:i+l-n})}));t.on(o.UP,(()=>{this.app.off_(l),t.off(o.UP)}))}))}addEdgeEvents(t,e){t.on(o.DOWN,(s=>{const{x:i,y:h}=t,{x:n,y:l}=s.getPagePoint(),r=this.app.on_(o.MOVE,(t=>{const{x:s,y:o}=t.getPagePoint(),r={index:e,x:i+s-n,y:h+o-l};(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),O(this.line,[r]),O(this.selectItem,[r])}));t.on(o.UP,(()=>{this.app.off_(r),t.off(o.UP),t.off(o.DOWN),this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds)}))}))}addMidEvents(t,e){t.on(o.DOWN,(s=>{const{x:i,y:h}=t,{x:n,y:l}=s.getPagePoint();let r=!1;const d=this.app.on_(o.MOVE,(t=>{const{x:s,y:o}=t.getPagePoint(),d={x:i+s-n,y:h+o-l},a=Object.assign(Object.assign({},d),{index:e+1});(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),r?(O(this.line,[a]),O(this.selectItem,[a])):(r=!0,b(this.line,[d],e+1),b(this.selectItem,[d],e+1))}));t.on(o.UP,(()=>{this.app.off_(d),t.off(o.UP),t.off(o.DOWN),this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds)}))}))}redrawEllipses(){const{points:t}=this.selectItem,e=W(t);this.drawEdgeEllipses(t),this.drawMidEllipses(e)}removeEllipses(){this.edgeEllipses.forEach((t=>{t.remove()})),this.midEllipses.forEach((t=>{t.remove()})),this.edgeEllipses=[],this.midEllipses=[]}}c([n(y)],D.prototype,"zIndex",void 0);class N extends l{constructor(t={}){const{color:e,strokeWidth:s,ellipseWidth:i}=t;super(),this.color=null!=e?e:x,this.strokeWidth=null!=s?s:2,this.ellipseWidth=null!=i?i:10,this.line=null,this.rect=null,this.selectItem=null,this.edgeEllipses=[],this.midEllipses=[],this.initEvents()}initEvents(){this.waitLeafer((()=>{const{isApp:t,zoomLayer:e}=this.app;if(!t||!e||e!=this.parent)throw new Error("OrthoPolylineEditor must be added to the zoomLayer of the App!");this.app.on(o.DOWN,this.downHandler.bind(this)),this.app.on(r.ZOOM,this.zoomHandler.bind(this))}))}downHandler(t){const e=t.target;e!==this.selectItem&&e.parent!==this&&(this.selectItem&&(this.selectItem=null,this.clearEditor()),"OrthoPolyline"===e.tag&&(this.set({x:e.x,y:e.y}),this.selectItem=e,this.drawEditor()))}zoomHandler(){if(!this.selectItem)return;const{scale:t}=this.leafer,e=this.strokeWidth/t,s=this.ellipseWidth/t;this.line.setAttr("strokeWidth",e),this.edgeEllipses.forEach((t=>{t.set({width:s,height:s,strokeWidth:e})})),this.midEllipses.forEach((t=>{t.set({width:s,height:s,strokeWidth:e})}))}drawEditor(){const{points:t}=this.selectItem,e=P(t),s=W(e);this.drawLine(e),this.drawRect(),this.drawEdgeEllipses(e),this.drawMidEllipses(s)}clearEditor(){this.edgeEllipses.forEach((t=>{t.off(o.DOWN)})),this.midEllipses.forEach((t=>{t.off(o.DOWN)})),this.rect.off(o.DOWN),this.line=null,this.rect=null,this.edgeEllipses=[],this.midEllipses=[],this.clear()}drawRect(){const{x:t,y:e,width:s,height:i}=this.selectItem.boxBounds;this.rect=new d({y:e,x:t,width:s,height:i,fill:"rgba(0, 0, 0, 0)"}),this.add(this.rect),this.addRectEvents(this.rect)}drawLine(t){const{scale:e}=this.leafer,s=this.strokeWidth/e;this.line=new a({points:t,stroke:this.color,strokeWidth:s}),this.add(this.line)}drawEdgeEllipses(t){const{scale:e}=this.leafer,s=this.ellipseWidth/e,i=this.strokeWidth/e;[t[0],t.at(-1)].forEach(((t,e)=>{const h=new p({width:s,height:s,x:t.x,y:t.y,around:"center",stroke:this.color,strokeWidth:i,fill:"#fff"});this.edgeEllipses.push(h),this.addEdgeEvents(h,e)})),this.add(this.edgeEllipses)}drawMidEllipses(t){const{scale:e}=this.leafer,s=this.ellipseWidth/e,i=this.strokeWidth/e,{points:h}=this.selectItem;t.forEach(((t,e)=>{const n=new p({width:s,height:s,x:t.x,y:t.y,around:"center",stroke:"#fff",strokeWidth:i,fill:this.color,visible:k(h,e)});this.midEllipses.push(n),this.addMidEvents(n,e)})),this.add(this.midEllipses)}addRectEvents(t){t.on(o.DOWN,(e=>{const{x:s,y:i}=this.selectItem,{x:h,y:n}=e.getPagePoint(),l=this.app.on_(o.MOVE,(t=>{const{x:e,y:l}=t.getPagePoint();this.selectItem.set({x:s+e-h,y:i+l-n}),this.set({x:s+e-h,y:i+l-n})}));t.on(o.UP,(()=>{this.app.off_(l),t.off(o.UP)}))}))}addEdgeEvents(t,e){t.on(o.DOWN,(s=>{const{x:i,y:h}=t,n=s.getPagePoint(),l={x:i,y:h},r={side:null,spaced:null},d=this.app.on_(o.MOVE,(t=>{const s=t.getPagePoint();(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),this.handleEdgeMove(l,n,s,e,r)}));t.on(o.UP,(()=>{this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds),this.app.off_(d),t.off(o.UP),t.off(o.DOWN)}))}))}addMidEvents(t,e){t.on(o.DOWN,(s=>{const{x:i,y:h}=t,n=s.getPagePoint(),l={x:i,y:h},r={index:e,pre:null,next:null},d=this.app.on_(o.MOVE,(t=>{const e=t.getPagePoint();(this.edgeEllipses.length||this.midEllipses.length)&&this.removeEllipses(),this.handleMidMove(l,n,e,r)}));t.on(o.UP,(()=>{this.redrawEllipses(),this.rect.set(this.selectItem.boxBounds),this.app.off_(d),t.off(o.UP),t.off(o.DOWN)}))}))}handleEdgeMove(t,e,s,i,h){const{x:n,y:l}=s,{points:o}=this.selectItem,{x:r,y:d}=t,{x:a,y:p}=e,c=0===i,x={x:r+n-a,y:d+l-p};2===o.length?this.handleTwoPoints(c,x,o,h):this.handleMultiPoints(c,x,o,h)}handleTwoPoints(t,e,s,i){const h=v(s[0],s[1]),n=t?s[1]:s[0],l=h?"x":"y",o=h?"y":"x",r=t?0:s.length-1,d=Math.abs(e[o]-n[o]),a=[],p=[];if(!(Math.abs(e[l]-n[l])<f)){if(d<f)p.push({index:r,x:h?e.x:n.x,y:h?n.y:e.y});else{const{side:o,spaced:d}=i;if(p.push({index:r,x:e.x,y:e.y}),o)i.side=null,a.push({x:h?e.x:o.x,y:h?o.y:e.y});else{const o=d?d[l]:(s[0][l]+s[1][l])/2;if(Math.abs(o-e[l])<f)return;const r={x:h?o:e.x,y:h?e.y:o},p={x:h?o:n.x,y:h?n.y:o};i.spaced=null,t?a.push(r,p):a.push(p,r)}}p.length&&(O(this.selectItem,p),O(this.line,p)),a.length&&(b(this.selectItem,a,1),b(this.line,a,1))}}handleMultiPoints(t,e,s,i){const{side:h,spaced:n}=i,l=s.length,o=t?s[0]:s.at(-1),r=t?s[1]:s.at(-2),d=t?s[2]:s.at(-3),a=t?s[3]:s.at(-4),p=v(o,r),c=t?0:l-1,x=t?1:l-2,y=p?"x":"y",u=p?"y":"x",E=Math.abs(e[u]-r[u]),g=Math.abs(e[y]-r[y]),m=Math.abs(e[u]-d[u]),w=Math.abs(e[y]-d[y]),W=[],P=[];let M=null;if(!(m<f&&w<f)){if(a){const t=Math.abs(e[u]-a[u]),s=Math.abs(e[y]-a[y]);if(t<f&&s<f)return}if(h||n){if(g<f)return;if(E<f)P.push({index:c,x:p?e.x:r.x,y:p?r.y:e.y});else if(P.push({index:c,x:e.x,y:e.y}),h)i.side=null,W.push({x:p?e.x:h.x,y:p?h.y:e.y});else{if(Math.abs(n[y]-e[y])<f)return;const s={x:p?n.x:e.x,y:p?e.y:n.y},h={x:p?n.x:r.x,y:p?r.y:n.y};i.spaced=null,t?W.push(s,h):W.push(h,s)}}else if(g<f)P.push({index:c,x:p?r.x:e.x,y:p?e.y:r.y}),i.side={x:p?r.x:e.x,y:p?e.y:r.y},M={index:x,count:1};else if(m<f){const s=t?1:l-3||1,h=3===l?1:2;P.push({index:c,x:p?e.x:d.x,y:p?d.y:e.y}),i.spaced={x:p?r.x:d.x,y:p?d.y:r.y},M={index:s,count:h}}else P.push({index:c,x:e.x,y:e.y},{index:x,x:p?r.x:e.x,y:p?e.y:r.y});if(P.length&&(O(this.line,P),O(this.selectItem,P)),W.length){const e=t?1:l-1;b(this.selectItem,W,e),b(this.line,W,e)}if(M){const{index:t,count:e}=M;I(this.selectItem,t,e),I(this.line,t,e)}}}handleMidMove(t,e,s,i){const{x:h,y:n}=s,l=this.selectItem.points,o=l.length,{index:r}=i,{x:d,y:a}=t,{x:p,y:c}=e,x={x:d+h-p,y:a+n-c};0===r||r===o-2?this.handleEdgeLine(x,l,i):this.handleOtherLine(x,l,i)}handleEdgeLine(t,e,s){const{pre:i,next:h,index:n}=s,l=Object.assign({},s),o=e.length,r=2===o||0===n?e[0]:e[o-2],d=2===o||0===n?e[1]:e[o-1],a=v(r,d),p=a?"y":"x",c=Math.abs(t[p]-r[p]),x=Math.abs(t[p]-d[p]),y=[],u=[];if(!(c<f||x<f)&&(i?(l.index+=2,l.pre=null,y.push({x:a?i.x:r.x,y:a?r.y:i.y},{x:a?i.x:t.x,y:a?t.y:i.y})):0===n?(l.index+=1,y.push({x:a?r.x:t.x,y:a?t.y:r.y})):u.push({index:o-2,x:a?r.x:t.x,y:a?t.y:r.y}),h?(l.next=null,y.push({x:a?h.x:t.x,y:a?t.y:h.y},{x:a?h.x:d.x,y:a?d.y:h.y})):n===o-2?y.push({x:a?d.x:t.x,y:a?t.y:d.y}):u.push({index:1,x:a?d.x:t.x,y:a?t.y:d.y}),s.pre=l.pre,s.next=l.next,s.index=l.index,u.length&&(O(this.selectItem,u),O(this.line,u)),y.length)){const t=0===n?1:o-1;b(this.selectItem,y,t),b(this.line,y,t)}}handleOtherLine(t,e,s){const{pre:i,next:h,index:n}=s,l=Object.assign({},s),o=e.length,r=e[n-1],d=e[n],a=e[n+1],p=e[n+2],c=v(d,a),x=c?"x":"y",y=c?"y":"x",u=Math.abs(t[y]-r[y]),E=Math.abs(t[y]-p[y]),g=[],m=[],w={preCount:0,nextCount:0};if(i){const e=Math.abs(t[y]-d[y]);if(E>=f&&e<f)return;const s=E<f?p:t;l.index+=2,l.pre=null,g.push({x:c?i.x:d.x,y:c?d.y:i.y},{x:c?i.x:s.x,y:c?s.y:i.y})}else if(u<f&&u<=E){const e=1===n?1:2;w.preCount=e,l.index-=e,1!==n&&(l.pre={x:c?d.x:t.x,y:c?t.y:d.y})}else if(E<f){if(e[n+3]){if(Math.abs(e[n+3][x]-d[x])<f)return}m.push({index:n,x:c?d.x:p.x,y:c?p.y:d.y})}else m.push({index:n,x:c?d.x:t.x,y:c?t.y:d.y});if(h){const e=Math.abs(t[y]-a[y]);if(u>=f&&e<f)return;const s=u<f?r:t;l.next=null,g.push({x:c?h.x:s.x,y:c?s.y:h.y},{x:c?h.x:a.x,y:c?a.y:h.y})}else if(E<f&&E<=u){const e=n===o-3?1:2;w.nextCount=e,n!==o-3&&(l.next={x:c?a.x:t.x,y:c?t.y:a.y})}else if(u<f){if(e[n-2]){if(Math.abs(e[n-2][x]-a[x])<f)return}m.push({index:n+1,x:c?a.x:r.x,y:c?r.y:a.y})}else m.push({index:n+1,x:c?a.x:t.x,y:c?t.y:a.y});if(s.pre=l.pre,s.next=l.next,s.index=l.index,m.length&&(O(this.selectItem,m),O(this.line,m)),g.length&&(b(this.selectItem,g,n+1),b(this.line,g,n+1)),w.preCount||w.nextCount){const{preCount:t,nextCount:e}=w,s=t+e;let i=t?n-1||1:n+1;i>=n+1&&(i+=g.length),I(this.selectItem,i,s),I(this.line,i,s)}}redrawEllipses(){const{points:t}=this.selectItem,e=W(t);this.drawEdgeEllipses(t),this.drawMidEllipses(e)}removeEllipses(){this.edgeEllipses.forEach((t=>{t.remove()})),this.midEllipses.forEach((t=>{t.remove()})),this.edgeEllipses=[],this.midEllipses=[]}}c([n(y)],N.prototype,"zIndex",void 0);export{w as FreePolyline,D as FreePolylineEditor,_ as OrthoPolyline,N as OrthoPolylineEditor};
